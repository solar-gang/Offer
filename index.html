<!-- index.html (script replacement) -->
<script>
/**
 * Solar + Storage Closing Tool
 *
 * Goals:
 * - Deterministic slide navigation
 * - Robust calculator + year wheel
 * - No duplicate IDs / no inline handlers
 * - Better accessibility for modal
 */
(() => {
  "use strict";

  /*** Config ***/
  const ASSETS = {
    logo: "4A5B0E0C-50D9-4752-8469-F61A667110D8.png",
    billNoSolar: "Scebill.jpeg",
    billSolar: "IMG_9100.jpeg",
    outageVideo: "Outagevideo.mp4",
    linkSCE: "https://www.sce.com/save-money/rates-financing/residential-rate-plans/understanding-updates-to-your-bill",
    linkLAT: "https://www.latimes.com/business/story/2025-05-22/edison-general-rate-case",
  };

  const YEARS = 25;

  /*** Tiny DOM helpers ***/
  const $ = (id) => document.getElementById(id);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  /*** Number + money helpers ***/
  function toNumber(value) {
    const raw = String(value ?? "").trim();
    if (!raw) return 0;
    const cleaned = raw.replace(/[^0-9.\-]/g, "");
    const n = Number.parseFloat(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function clamp(n, min, max) {
    return Math.max(min, Math.min(max, n));
  }

  function money(n, digits) {
    const v = Number.isFinite(n) ? n : 0;
    return v.toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: digits,
      maximumFractionDigits: digits,
    });
  }

  function money0(n) { return money(n, 0); }
  function money2(n) { return money(n, 2); }

  function monthlySeries(baseMonthly, escPct, years = YEARS) {
    const r = escPct / 100;
    const out = new Array(years);
    for (let y = 0; y < years; y++) out[y] = baseMonthly * Math.pow(1 + r, y);
    return out;
  }

  function totalSeries(series) {
    let sum = 0;
    for (let i = 0; i < series.length; i++) sum += series[i] * 12;
    return sum;
  }

  /*** Popup ***/
  function popupArticle(url) {
    const w = Math.min(1100, window.screen.width * 0.92);
    const h = Math.min(820, window.screen.height * 0.88);
    const left = (window.screen.width - w) / 2;
    const top = (window.screen.height - h) / 2;

    const win = window.open(
      url,
      "LOS_ARTICLE",
      `popup=yes,scrollbars=yes,resizable=yes,width=${w},height=${h},left=${left},top=${top}`
    );

    if (win) win.focus();
    else window.location.href = url;
  }

  /*** Modal ***/
  const modal = $("modal");
  const modalTitle = $("modalTitle");
  const modalImg = $("modalImg");
  const modalClose = $("modalClose");

  let lastFocusedEl = null;

  function openModal(title, src) {
    lastFocusedEl = document.activeElement;
    modalTitle.textContent = title;
    modalImg.src = src;
    modal.classList.add("show");
    modal.setAttribute("role", "dialog");
    modal.setAttribute("aria-modal", "true");
    modalClose.focus();
  }

  function closeModal() {
    modal.classList.remove("show");
    modalImg.src = "";
    if (lastFocusedEl && typeof lastFocusedEl.focus === "function") {
      lastFocusedEl.focus();
    }
  }

  /*** Slides + HUD ***/
  const progressFill = $("progressFill");
  const slideCounter = $("slideCounter");

  const slides = $$("[data-slide]");
  let idx = 0;

  function updateHUD() {
    slideCounter.textContent = `Slide ${idx + 1} / ${slides.length}`;
    const pct = (idx / Math.max(1, slides.length - 1)) * 100;
    progressFill.style.width = `${pct}%`;
  }

  function activate(i) {
    idx = clamp(i, 0, slides.length - 1);
    for (let n = 0; n < slides.length; n++) {
      slides[n].classList.toggle("active", n === idx);
    }
    updateHUD();

    const body = slides[idx].querySelector(".slideBody");
    if (body) body.scrollTop = 0;
  }

  function next() { activate(idx + 1); }
  function prev() { activate(idx - 1); }

  /*** Calculator state ***/
  let year = 1;
  const cache = { u: [], a: [], b: [], uTotal: 0, aTotal: 0, bTotal: 0 };

  function recalc() {
    const uPay = toNumber($("uPay").value);
    const uEsc = toNumber($("uEsc").value);
    const aPay = toNumber($("aPay").value);
    const aEsc = toNumber($("aEsc").value);
    const bPay = toNumber($("bPay").value);
    const bEsc = toNumber($("bEsc").value);

    cache.u = monthlySeries(uPay, uEsc);
    cache.a = monthlySeries(aPay, aEsc);
    cache.b = monthlySeries(bPay, bEsc);

    cache.uTotal = totalSeries(cache.u);
    cache.aTotal = totalSeries(cache.a);
    cache.bTotal = totalSeries(cache.b);

    $("uTotal").textContent = money0(cache.uTotal);
    $("aSave25").textContent = money0(cache.uTotal - cache.aTotal);
    $("bSave25").textContent = money0(cache.uTotal - cache.bTotal);

    setYear(year, true);
  }

  function setYear(newYear, snapWheel) {
    year = clamp(Number.parseInt(newYear, 10) || 1, 1, YEARS);
    $("yearBig").textContent = String(year);
    $("yearChip").textContent = String(year);

    const i = year - 1;
    const uM = cache.u[i] ?? 0;
    const aM = cache.a[i] ?? 0;
    const bM = cache.b[i] ?? 0;

    $("uM").textContent = money2(uM);
    $("aM").textContent = money2(aM);
    $("bM").textContent = money2(bM);

    $("uY").textContent = `Annual: ${money0(uM * 12)}`;
    $("aY").textContent = `Annual: ${money0(aM * 12)}`;
    $("bY").textContent = `Annual: ${money0(bM * 12)}`;

    const bestMonthly = Math.min(aM, bM);
    const bestAnnual = (uM - bestMonthly) * 12;

    $("bestAnnual").textContent = money0(bestAnnual);
    $("bestAnnual").style.color = bestAnnual >= 0 ? "var(--opt1)" : "var(--utility)";

    const wheel = $("yearWheel");
    if (!wheel) return;

    const items = wheel.querySelectorAll(".wheelItem");
    items.forEach((el, n) => el.classList.toggle("active", n === i));

    if (snapWheel) {
      const target = items[i];
      if (target) {
        const top = target.offsetTop - (wheel.clientHeight / 2 - target.clientHeight / 2);
        wheel.scrollTo({ top, behavior: "auto" });
      }
    }
  }

  /*** Year wheel builder ***/
  function buildYearWheel() {
    const wheel = $("yearWheel");
    if (!wheel) return;

    wheel.innerHTML = "";

    for (let y = 1; y <= YEARS; y++) {
      const div = document.createElement("div");
      div.className = "wheelItem" + (y === 1 ? " active" : "");
      div.textContent = `Year ${y}`;
      div.addEventListener("click", () => setYear(y, true));
      wheel.appendChild(div);
    }

    const ITEM_H = 44;
    const PAD = 88;
    let ticking = false;

    wheel.addEventListener(
      "scroll",
      () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          ticking = false;
          const center = wheel.scrollTop + wheel.clientHeight / 2;
          const pos = center - PAD - ITEM_H / 2;
          const index = clamp(Math.round(pos / ITEM_H), 0, YEARS - 1);
          const newYear = index + 1;
          if (newYear !== year) setYear(newYear, false);
        });
      },
      { passive: true }
    );

    $("yearMinus").addEventListener("click", () => setYear(year - 1, true));
    $("yearPlus").addEventListener("click", () => setYear(year + 1, true));

    ["uPay", "uEsc", "aPay", "aEsc", "bPay", "bEsc"].forEach((id) => {
      const el = $(id);
      if (!el) return;
      el.addEventListener("input", recalc, { passive: true });
    });
  }

  /*** Start slide -> Calculator sync ***/
  function syncStartBillToCalculator() {
    const v = $("startBill").value;
    $("uPay").value = v;
    recalc();
  }

  /*** Reset ***/
  function resetAll() {
    $("startBill").value = "458";
    $("uPay").value = "458";
    $("uEsc").value = "9";
    $("aPay").value = "295";
    $("aEsc").value = "0";
    $("bPay").value = "325";
    $("bEsc").value = "0";
    year = 1;
    recalc();
    activate(0);
  }

  /*** Wiring ***/
  function wireNav() {
    $("btnNext").addEventListener("click", next);
    $("btnPrev").addEventListener("click", prev);
    $("btnNextTop").addEventListener("click", next);
    $("btnPrevTop").addEventListener("click", prev);
    $("btnHome").addEventListener("click", () => activate(0));
    $("btnReset").addEventListener("click", resetAll);

    document.addEventListener("keydown", (e) => {
      if (modal.classList.contains("show") && e.key === "Escape") {
        e.preventDefault();
        closeModal();
        return;
      }
      if (e.key === "ArrowRight" || e.key === " " || e.key === "PageDown") {
        e.preventDefault();
        next();
      }
      if (e.key === "ArrowLeft" || e.key === "PageUp") {
        e.preventDefault();
        prev();
      }
      if (e.key === "Home") {
        e.preventDefault();
        activate(0);
      }
      if (e.key === "End") {
        e.preventDefault();
        activate(slides.length - 1);
      }
    });

    // Data-go buttons (replaces inline onclick)
    $$(".js-go").forEach((btn) => {
      btn.addEventListener("click", () => {
        const n = Number.parseInt(btn.dataset.go ?? "0", 10);
        if (Number.isFinite(n)) activate(n);
      });
    });

    // "Year quick jump" buttons
    $$("[data-year]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const n = Number.parseInt(btn.dataset.year ?? "1", 10);
        setYear(n, true);
      });
    });
  }

  function wireLinks() {
    // Fix: use classes instead of duplicate IDs
    $$(".js-btn-sce").forEach((el) => {
      el.addEventListener("click", () => popupArticle(ASSETS.linkSCE));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          popupArticle(ASSETS.linkSCE);
        }
      });
    });

    $$(".js-btn-lat").forEach((el) => {
      el.addEventListener("click", () => popupArticle(ASSETS.linkLAT));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          popupArticle(ASSETS.linkLAT);
        }
      });
    });
  }

  function wireModal() {
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
  }

  function wireImages() {
    const noSolar = $("imgBillNoSolar");
    const solar = $("imgBillSolar");

    noSolar.addEventListener("click", () => openModal("Bill (No Solar)", ASSETS.billNoSolar));
    solar.addEventListener("click", () => openModal("Bill (Solar + Storage)", ASSETS.billSolar));
  }

  function bootAssets() {
    $("logoImg").src = ASSETS.logo;

    $("imgBillNoSolar").src = ASSETS.billNoSolar;
    $("imgBillSolar").src = ASSETS.billSolar;

    const vid = $("outageVid");
    const src = vid.querySelector("source");
    src.src = ASSETS.outageVideo;
    vid.load();
  }

  function bootCalculator() {
    $("startBill").addEventListener("input", syncStartBillToCalculator);

    // Initialize from start bill
    $("uPay").value = $("startBill").value;

    buildYearWheel();
    recalc();
    setYear(1, true);
  }

  /*** Init ***/
  function init() {
    bootAssets();
    wireNav();
    wireLinks();
    wireModal();
    wireImages();
    bootCalculator();
    activate(0);
  }

  init();
})();
</script>
