<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Solar + Storage Closing Tool</title>
<meta name="theme-color" content="#0b1017"/>

<style>
  :root{
    --navy:#0b1017;
    --navy2:#06122a;
    --gold:#FBC909;
    --teal:#3AADBB;

    --utility:#ff3b30;
    --opt1:#34c759;
    --opt2:#00c2ff;

    --text:rgba(255,255,255,.96);
    --muted:rgba(255,255,255,.72);
    --muted2:rgba(255,255,255,.56);

    --grad:linear-gradient(135deg,var(--gold),var(--teal));
    --shadow: 0 18px 70px rgba(0,0,0,.45);
    --r:16px;
    --r2:22px;

    --safeT: env(safe-area-inset-top);
    --safeB: env(safe-area-inset-bottom);
    --safeL: env(safe-area-inset-left);
    --safeR: env(safe-area-inset-right);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 460px at 14% 10%, rgba(251,201,9,.18), transparent 60%),
      radial-gradient(900px 460px at 86% 12%, rgba(58,173,187,.16), transparent 60%),
      linear-gradient(180deg, var(--navy2), var(--navy));
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  html.ios .luxShadow{ box-shadow:none !important; }
  html.ios .hoverLift:hover{ transform:none !important; box-shadow:none !important; }
  html.ios .slide{ transition:none !important; }
  html.ios input:focus{ box-shadow:none !important; }

  a{color:#cfe8ff;text-decoration:none}
  a:hover{text-decoration:underline}
  button, a, input { -webkit-tap-highlight-color: transparent; }

  /* ===== Top Bar ===== */
  .topbar{
    position:fixed; inset:0 0 auto 0;
    z-index:160;
    padding-top:var(--safeT);
    background: rgba(10,16,24,.88);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .topbarInner{
    max-width:1280px;
    margin:0 auto;
    padding:10px 14px;
    padding-left: calc(14px + var(--safeL));
    padding-right: calc(14px + var(--safeR));
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:12px; min-width:220px; overflow:hidden;}
  .brand img{
    height:54px; width:auto; display:block;
    filter:drop-shadow(0 12px 28px rgba(0,0,0,.35));
  }
  .brandTitle{display:flex; flex-direction:column; line-height:1.1; min-width:0;}
  .brandTitle .name{
    font-weight:1000; letter-spacing:-.02em;
    display:flex; align-items:center; gap:10px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background:var(--grad);
    box-shadow: 0 0 0 6px rgba(251,201,9,.10), 0 0 26px rgba(58,173,187,.18);
    flex:0 0 auto;
  }
  .brandTitle .sub{
    font-size:12px; color:var(--muted2);
    margin-top:3px; letter-spacing:.02em;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .navTop{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
  .btn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:950;
    cursor:pointer;
    min-height:42px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    user-select:none;
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .btn.hoverLift:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.10);
    box-shadow: 0 14px 44px rgba(0,0,0,.25);
    border-color: rgba(255,255,255,.18);
  }
  .btn.primary{
    background: var(--grad);
    color:#07121b;
    border-color: rgba(255,255,255,.18);
    box-shadow: 0 18px 58px rgba(58,173,187,.14), 0 18px 58px rgba(251,201,9,.10);
  }
  .btn.danger{border-color: rgba(255,59,48,.25); background: rgba(255,59,48,.10);}
  .btn.icon{padding:10px 12px; min-width:46px;}

  @media (max-width:860px){
    .brand img{height:50px;}
    .brandTitle .sub{display:none;}
    .navTop .btn.hideMobile{display:none;}
  }

  .progressWrap{
    max-width:1280px; margin:0 auto;
    padding: 0 14px 10px;
    padding-left: calc(14px + var(--safeL));
    padding-right: calc(14px + var(--safeR));
  }
  .progress{
    height:7px;
    border-radius:999px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .progress > div{height:100%; width:0%; background:var(--grad); transition: width .18s ease;}

  /* ===== Deck ===== */
  .deck{
    height:100%;
    padding-top: calc(88px + var(--safeT));
    padding-bottom: calc(86px + var(--safeB));
    display:flex;
    align-items:stretch;
    justify-content:center;
  }
  .stage{
    width:min(1280px, 100vw);
    height:100%;
    padding: 14px 16px;
    padding-left: calc(16px + var(--safeL));
    padding-right: calc(16px + var(--safeR));
    position:relative;
  }
  .slide{
    position:absolute;
    inset:14px 16px;
    inset-left: calc(16px + var(--safeL));
    inset-right: calc(16px + var(--safeR));
    border:1px solid rgba(255,255,255,.14);
    border-radius: var(--r2);
    background: rgba(255,255,255,.05);
    overflow:hidden;
    opacity:0;
    transform: translateY(10px) scale(.99);
    pointer-events:none;
    transition: opacity .16s ease, transform .16s ease;
  }
  .slide.active{
    opacity:1;
    transform: translateY(0) scale(1);
    pointer-events:auto;
  }
  .luxShadow{ box-shadow: var(--shadow); }

  .slideHead{
    padding:16px 18px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .slideHead h2{
    margin:0;
    font-size: 15px;
    letter-spacing:.04em;
    text-transform:uppercase;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .spark{width:10px;height:10px;border-radius:999px;background:var(--grad); box-shadow:0 0 22px rgba(251,201,9,.16), 0 0 22px rgba(58,173,187,.14);}

  .slideBody{
    padding:18px;
    height: calc(100% - 58px);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Bottom controls */
  .presentBar{
    position:fixed;
    left: 12px;
    right: 12px;
    bottom: calc(12px + var(--safeB));
    z-index:180;
    display:flex;
    justify-content:center;
    pointer-events:none;
  }
  .presentShell{
    pointer-events:auto;
    width:min(980px, 100%);
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.24);
    border-radius:18px;
    padding:10px;
  }
  .presentShell .btn{flex:1; min-height:46px;}
  .presentShell .btn.primary{flex:1.2;}
  @media (max-width:520px){
    .presentShell{gap:8px; padding:8px;}
    .presentShell .btn{min-height:44px; padding:10px 10px;}
  }

  /* Helpers */
  .grid{display:grid; gap:14px;}
  .grid2{grid-template-columns: 1.05fr .95fr;}
  .grid2eq{grid-template-columns:1fr 1fr;}
  @media (max-width:980px){ .grid2, .grid2eq{grid-template-columns:1fr;} }

  .pill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:10px 12px;
    font-weight:950;
    color: rgba(255,255,255,.88);
    display:inline-flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
  }

  .gradText{
    background:var(--grad);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    font-weight:1000;
  }

  /* ===== Slide 1 simplified ===== */
  .centerStage{
    height:100%;
    display:grid;
    place-items:center;
  }
  .heroCard{
    width:min(980px, 100%);
    border:1px solid rgba(255,255,255,.14);
    border-radius:22px;
    background:
      radial-gradient(740px 340px at 20% 20%, rgba(251,201,9,.14), transparent 62%),
      radial-gradient(740px 340px at 80% 20%, rgba(58,173,187,.12), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    padding:18px;
  }
  html.ios .heroCard{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); }

  .heroTop{
    display:flex; align-items:flex-end; justify-content:space-between;
    gap:12px; flex-wrap:wrap;
  }
  .heroTop h1{
    margin:0;
    font-size: clamp(28px, 4.2vw, 56px);
    letter-spacing:-.055em;
    line-height:1.02;
  }
  .heroTop .tag{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    white-space:nowrap;
  }
  .heroSub{
    margin-top:10px;
    color:var(--muted);
    font-weight:900;
    font-size:15px;
    line-height:1.5;
  }

  .formGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:14px;
  }
  @media (max-width:980px){ .formGrid{grid-template-columns:1fr;} }

  .klabel{
    display:block;
    color:rgba(255,255,255,.78);
    font-weight:1000;
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    margin-bottom:6px;
  }
  input{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
    color: rgba(255,255,255,.96);
    font-weight:1000;
    font-size:16px;
    outline:none;
    min-height:44px;
  }
  input:focus{
    border-color: rgba(58,173,187,.72);
    box-shadow: 0 0 0 6px rgba(58,173,187,.12);
  }

  .metricRow{
    margin-top:12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:14px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .metricRow .mk{color:rgba(255,255,255,.70); font-weight:1000; font-size:11px; letter-spacing:.12em; text-transform:uppercase;}
  .metricRow .mv{font-weight:1000; font-size: clamp(26px, 3.6vw, 42px); letter-spacing:-.04em;}
  .metricRow .mv.red{color:var(--utility);}

  /* ===== Bills ===== */
  .billFrame{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    overflow:hidden;
  }
  .billViewport{
    height: clamp(260px, 42vh, 520px);
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .billViewport img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    cursor:pointer;
  }
  .cap{
    padding:12px 14px;
    border-top:1px solid rgba(255,255,255,.10);
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    background: rgba(0,0,0,.14);
    font-weight:1000;
  }
  .cap small{color:var(--muted2); font-weight:900; white-space:nowrap;}

  /* TOU link buttons */
  .linkBtns{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:12px;
    margin-top:14px;
  }
  @media (max-width:980px){ .linkBtns{grid-template-columns:1fr;} }
  .linkBtn{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    padding:14px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .linkBtn:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.18);
  }
  .linkTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .capTag{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:1000;
    font-size:12px;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
  }
  .linkTitle{font-weight:1000; letter-spacing:-.02em; font-size:18px; line-height:1.12;}
  .linkDesc{color:var(--muted); font-weight:900; font-size:13.5px; line-height:1.4;}

  /* Proof text */
  .headlineBox{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    padding:16px;
  }
  .headlineBox .big{
    margin:0 0 10px;
    font-size: clamp(22px, 3.1vw, 40px);
    font-weight:1000;
    letter-spacing:-.045em;
    line-height:1.06;
  }
  .headlineBox .sub{margin:0; color:var(--muted); font-weight:900; font-size:15px; line-height:1.45;}
  .bullets{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(255,255,255,.05);
    padding:16px;
    display:grid;
    gap:12px;
    margin-top:12px;
  }
  .bItem{
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    background: rgba(0,0,0,.14);
    padding:12px;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .bIcon{
    width:34px;height:34px;border-radius:12px;
    background: var(--grad);
    color:#07121b;
    font-weight:1000;
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  }
  .bText strong{font-weight:1000; letter-spacing:-.02em;}
  .bText span{display:block; margin-top:3px; color:var(--muted); font-weight:850; font-size:13.5px; line-height:1.35;}

  /* Outage */
  .videoShell{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    overflow:hidden;
    background: rgba(0,0,0,.22);
  }
  .videoViewport{
    width:100%;
    height: clamp(260px, 46vh, 520px);
    background:#000;
  }
  video{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    background:#000;
  }
  .tagline{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: linear-gradient(135deg, rgba(251,201,9,.11), rgba(58,173,187,.09));
    padding:14px;
  }
  .tagline h3{
    margin:0;
    font-size: clamp(18px, 2.4vw, 28px);
    letter-spacing:-.03em;
    font-weight:1000;
  }
  .tagline p{
    margin:8px 0 0;
    color:var(--muted);
    font-weight:900;
    line-height:1.45;
  }
  .backupGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:12px;
  }
  @media (max-width:980px){ .backupGrid{grid-template-columns:1fr;} }
  .backupItem{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:12px;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .bkIcon{
    width:36px;height:36px;border-radius:14px;
    background: var(--grad);
    color:#07121b;
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    flex:0 0 auto;
  }
  .backupItem b{display:block; font-weight:1000; letter-spacing:-.01em;}
  .backupItem span{display:block; margin-top:3px; color:var(--muted); font-weight:900; font-size:13.5px; line-height:1.35;}

  .vppLinks{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
    margin-top:12px;
  }
  .vppCard{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    overflow:hidden;
  }
  .vppBtn{
    padding:14px;
    cursor:pointer;
  }
  .vppBtn:hover{ background: rgba(255,255,255,.06); }
  .vppBtn .t{font-weight:1000; font-size:16px; letter-spacing:-.01em;}
  .vppBtn .d{margin-top:8px; color:var(--muted); font-weight:900; font-size:13.5px; line-height:1.4;}

  /* Compare tool */
  .compareTop{display:grid; grid-template-columns: repeat(3,1fr); gap:12px;}
  @media (max-width:980px){ .compareTop{grid-template-columns:1fr;} }
  .col{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(255,255,255,.04);
    overflow:hidden;
  }
  .colHead{
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }
  .colHead .label{color:var(--muted2); font-weight:1000; font-size:11px; letter-spacing:.12em; text-transform:uppercase;}
  .colHead .title{margin-top:2px; font-weight:1000; font-size:18px; letter-spacing:-.02em;}
  .tag{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:950;
    font-size:12px;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
  }
  .colBody{padding:14px; display:grid; gap:10px;}
  .metricLine{
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .metricLine .mk{color:var(--muted2); font-weight:950; font-size:11px; letter-spacing:.12em; text-transform:uppercase;}
  .metricLine .mv{font-weight:1000; font-size:18px;}

  /* Year wheel */
  .yearPanel{
    margin-top:14px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:22px;
    background: rgba(255,255,255,.04);
    overflow:hidden;
  }
  .yearHead{
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: linear-gradient(135deg, rgba(251,201,9,.11), rgba(58,173,187,.09));
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .yearHead .t{font-weight:1000; letter-spacing:-.02em; display:flex; align-items:center; gap:10px;}
  .yearPill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:8px 10px;
    font-weight:1000;
    display:flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
  }
  .yearPill .dot2{width:10px;height:10px;border-radius:999px;background:var(--grad);}

  .yearBody{
    padding:16px;
    display:grid;
    grid-template-columns: .9fr 1.1fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:980px){ .yearBody{grid-template-columns:1fr;} }

  .wheelBox{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    display:grid;
    gap:12px;
  }
  .wheelTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
  .yearBig{font-size: clamp(46px, 6.6vw, 78px); font-weight:1000; letter-spacing:-.05em; line-height:1;}
  .dialBtns{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .miniBtn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    min-height:44px;
    cursor:pointer;
  }

  .wheel{
    position:relative;
    height:220px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    overflow:hidden;
  }
  .wheel::before{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(180deg, rgba(11,16,23,.92), transparent 26%, transparent 74%, rgba(11,16,23,.92));
    pointer-events:none;
    z-index:2;
  }
  .wheel::after{
    content:"";
    position:absolute;
    left:10px; right:10px;
    top: calc(50% - 22px);
    height:44px;
    border-radius:14px;
    border:1px solid rgba(251,201,9,.24);
    box-shadow: 0 0 0 6px rgba(58,173,187,.10);
    pointer-events:none;
    z-index:3;
  }

  .wheelList{
    height:100%;
    overflow-y:auto;
    scroll-snap-type:y mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 88px 0;
    margin:0;
  }
  .wheelList::-webkit-scrollbar{ width: 0; height:0; }
  .wheelItem{
    height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
    scroll-snap-align:center;
    font-weight:1000;
    font-size:20px;
    letter-spacing:-.01em;
    color: rgba(255,255,255,.72);
    user-select:none;
  }
  .wheelItem.active{
    color: rgba(255,255,255,.96);
    text-shadow: 0 10px 32px rgba(0,0,0,.35);
  }

  .yearCompare{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    display:grid;
    gap:12px;
  }
  .bigMoneyGrid{display:grid; grid-template-columns: repeat(3,1fr); gap:10px;}
  @media (max-width:980px){ .bigMoneyGrid{grid-template-columns:1fr;} }
  .bigTile{
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    border-radius:18px;
    padding:12px;
  }
  .bigTile .bk{
    color:var(--muted2);
    font-weight:1000;
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .chip{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:950;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
    font-size:12px;
  }
  .bigTile .m{
    margin-top:10px;
    font-size: clamp(34px, 5.4vw, 58px);
    font-weight:1000;
    letter-spacing:-.035em;
    line-height:1;
  }
  .yearSavings{
    border:1px solid rgba(52,199,89,.28);
    background: rgba(52,199,89,.10);
    border-radius:16px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    font-weight:1000;
  }
  .yearSavings .v{font-size:18px; color: var(--opt1); letter-spacing:-.01em;}

  /* Next Steps: Timeline + Company links/reviews */
  .timelineWrap{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:980px){ .timelineWrap{grid-template-columns:1fr;} }

  .timeline{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    gap:10px;
  }
  @media (max-width:980px){ .timeline{grid-template-columns:1fr;} }

  .step{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:14px;
    min-height:112px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .step:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18);}
  .step.active{
    border-color: rgba(58,173,187,.55);
    background: rgba(58,173,187,.10);
  }
  .num{
    width:30px;height:30px;border-radius:12px;
    background: var(--grad);
    color:#07121b;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:1000;
    margin-bottom:10px;
  }
  .step .t{font-weight:1000; letter-spacing:-.02em;}
  .step .d{margin-top:8px; color: rgba(255,255,255,.78); font-weight:900; font-size:13.5px; line-height:1.35;}

  .rightStack{display:grid; gap:12px;}
  .panel{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:16px;
  }
  .panel h3{
    margin:0;
    font-size: clamp(18px, 2.2vw, 28px);
    letter-spacing:-.03em;
    font-weight:1000;
  }
  .panel p{
    margin:10px 0 0;
    color:var(--muted);
    font-weight:900;
    line-height:1.5;
  }
  .tip{
    margin-top:12px;
    border:1px solid rgba(251,201,9,.22);
    background: rgba(251,201,9,.08);
    border-radius:16px;
    padding:12px;
    font-weight:1000;
    color: rgba(255,255,255,.92);
  }
  .siteGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    margin-top:12px;
  }
  .siteRow{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.14);
    border-radius:18px;
    padding:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .siteRow .name{
    font-weight:1000;
    letter-spacing:-.01em;
  }
  .siteRow .actions{display:flex; gap:8px; flex-wrap:wrap;}
  .btn.small{min-height:40px; padding:9px 10px;}
  .btn.linkish{border-color: rgba(58,173,187,.22); background: rgba(58,173,187,.10);}

  /* ===== Modal ===== */
  .modal{
    position:fixed;
    inset:0;
    z-index:220;
    display:none;
    align-items:center;
    justify-content:center;
    padding: calc(14px + var(--safeT)) calc(14px + var(--safeR)) calc(14px + var(--safeB)) calc(14px + var(--safeL));
    background: rgba(0,0,0,.72);
  }
  .modal.show{display:flex;}
  .modalBox{
    width:min(1100px, 100%);
    height:min(84vh, 880px);
    border:1px solid rgba(255,255,255,.16);
    border-radius:22px;
    background: rgba(10,16,24,.94);
    overflow:hidden;
    box-shadow: 0 20px 80px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
  }
  .modalTop{
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .modalTop .title{
    font-weight:1000;
    letter-spacing:-.02em;
    color: rgba(255,255,255,.92);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .modalActions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .iconBtn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    min-height:42px;
    cursor:pointer;
  }
  .modalBody{position:relative; flex:1; overflow:hidden;}

  .viewer{position:absolute; inset:0; overflow:hidden; background:#000;}
  .viewerCanvas{
    position:absolute; inset:0;
    cursor:grab;
    touch-action:none;
  }
  .viewerCanvas.grabbing{cursor:grabbing;}
  .viewerCanvas img{
    position:absolute;
    top:0; left:0;
    transform-origin: 0 0;
    user-select:none;
    -webkit-user-drag:none;
    max-width:none;
    max-height:none;
  }
  .zoomBar{
    position:absolute;
    left:12px; right:12px;
    bottom:12px;
    display:flex;
    gap:10px;
    align-items:center;
    z-index:3;
    pointer-events:none;
  }
  .zoomRange{
    flex:1;
    pointer-events:auto;
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    padding:0 10px;
    display:flex;
    align-items:center;
  }
  .zoomRange input{
    width:100%;
    height:24px;
    margin:0;
    background: transparent;
    border:0;
    padding:0;
    box-shadow:none;
    min-height:auto;
  }

  .frame{position:absolute; inset:0; background:#000;}
  .frame iframe{width:100%; height:100%; border:0; display:block; background:#000;}
</style>
</head>

<body>

<div class="topbar">
  <div class="topbarInner">
    <div class="brand">
      <img id="logoImg" alt="Logo"/>
      <div class="brandTitle">
        <div class="name"><span class="dot"></span> Leverage Our Sun</div>
        <div class="sub">Solar + Storage Closing Tool</div>
      </div>
    </div>

    <div class="navTop">
      <button class="btn hoverLift hideMobile" id="btnHome" type="button">Home</button>
      <button class="btn hoverLift hideMobile" id="btnPrevTop" type="button">Prev</button>
      <button class="btn primary hoverLift hideMobile" id="btnNextTop" type="button">Next</button>
      <button class="btn hoverLift icon" id="btnFS" type="button" title="Fullscreen">‚õ∂</button>
      <button class="btn danger hoverLift hideMobile" id="btnReset" type="button">Reset</button>
    </div>
  </div>
  <div class="progressWrap">
    <div class="progress"><div id="progressFill"></div></div>
  </div>
</div>

<div class="deck">
  <div class="stage" id="stage">

    <!-- SLIDE 1: Slogan + inputs + $/kWh -->
    <section class="slide luxShadow active" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Start</h2>
        <div class="pill"><span class="dot"></span> Win the day ‚Ä¢ Own the night</div>
      </div>

      <div class="slideBody">
        <div class="centerStage">
          <div class="heroCard">
            <div class="heroTop">
              <h1>Win the day. <span class="gradText">Own the night.</span></h1>
              <span class="tag">Baseline inputs</span>
            </div>
            <div class="heroSub">
              Enter their average monthly bill and annual kWh. This calculates today‚Äôs $/kWh and auto-fills the utility column in the calculator.
            </div>

            <div class="formGrid">
              <label>
                <span class="klabel">Average monthly bill ($)</span>
                <input id="custMonthly" inputmode="decimal" value="458">
              </label>
              <label>
                <span class="klabel">Annual usage (kWh)</span>
                <input id="custUsage" inputmode="decimal" value="12000">
              </label>
            </div>

            <div class="metricRow" style="margin-top:14px;">
              <div class="mk">Today‚Äôs average cost per kWh</div>
              <div class="mv red" id="custCpkwh">$0.00</div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
              <button class="btn primary hoverLift" type="button" onclick="go(1)">Continue</button>
              <button class="btn hoverLift" type="button" onclick="syncUtilityFromCustomer()">Apply to calculator</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 2: Problem + bill + TOU links -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> The Problem</h2>
        <div class="pill"><span class="dot"></span> Time-of-Use + rising rates</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="billFrame">
            <div class="billViewport">
              <img id="imgUtilityBill" alt="Utility bill without solar" />
            </div>
            <div class="cap">
              <div>Today‚Äôs bill (no solar)</div>
              <small>Tap to magnify</small>
            </div>
          </div>

          <div class="headlineBox">
            <div class="big">Why bills spike: <span class="gradText">TOU pricing</span></div>
            <p class="sub">
              Utility pricing is built around <b>when</b> power is purchased. Peak hours are priced highest.
              Solar + batteries change the timing: produce by day, store surplus, discharge during peak.
            </p>

            <div class="bullets">
              <div class="bItem"><div class="bIcon">‚è±Ô∏è</div><div class="bText"><strong>Peak costs more</strong><span>Grid-stress hours are priced higher.</span></div></div>
              <div class="bItem"><div class="bIcon">üìà</div><div class="bText"><strong>Pressure keeps building</strong><span>More electrification + grid upgrades = upward rate pressure.</span></div></div>
              <div class="bItem"><div class="bIcon">üßæ</div><div class="bText"><strong>Required charges stay</strong><span>You stay connected ‚Äî the goal is to buy less at peak pricing.</span></div></div>
            </div>

            <div class="linkBtns">
              <div class="linkBtn hoverLift" onclick="openLinkInModal('SCE Time-of-Use rates','https://www.sce.com/save-money/rates-financing/residential-rate-plans/time-of-use-rate-plans')">
                <div class="linkTop">
                  <span class="capTag">TOU</span>
                  <span class="capTag">Popup</span>
                </div>
                <div class="linkTitle">SCE Time-of-Use rates</div>
                <div class="linkDesc">Official TOU pricing and plan details.</div>
              </div>

              <div class="linkBtn hoverLift" onclick="openLinkInModal('SCE bill updates','https://www.sce.com/save-money/rates-financing/residential-rate-plans/understanding-updates-to-your-bill')">
                <div class="linkTop">
                  <span class="capTag">13% increase</span>
                  <span class="capTag">Popup</span>
                </div>
                <div class="linkTitle">SCE: Understanding updates</div>
                <div class="linkDesc">Explains why bill components and rates change.</div>
              </div>

              <div class="linkBtn hoverLift" onclick="openLinkInModal('LA Times: Edison rate case','https://www.latimes.com/business/story/2025-05-22/edison-general-rate-case')">
                <div class="linkTop">
                  <span class="capTag">L.A. fires</span>
                  <span class="capTag">Popup</span>
                </div>
                <div class="linkTitle">LA Times: Edison rate case</div>
                <div class="linkDesc">News context on continued utility rate pressure.</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- SLIDE 3: Proof bill -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Proof</h2>
        <div class="pill"><span class="dot"></span> Solar + Storage result</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="billFrame">
            <div class="billViewport">
              <img id="imgSolarBill" alt="Solar + storage bill example" />
            </div>
            <div class="cap">
              <div>Solar + storage bill example ($28)</div>
              <small>Tap to magnify</small>
            </div>
          </div>

          <div class="headlineBox">
            <div class="big">Why it can be <span class="gradText">$28</span></div>
            <p class="sub">
              Not ‚Äúfree power.‚Äù Controlled power. Solar covers the day. Batteries cover peak.
              The utility becomes the backup supplier instead of the primary supplier.
            </p>
            <div class="bullets">
              <div class="bItem"><div class="bIcon">‚òÄÔ∏è</div><div class="bText"><strong>Daytime offsets</strong><span>Solar reduces the kWh you would buy during the day.</span></div></div>
              <div class="bItem"><div class="bIcon">üîã</div><div class="bText"><strong>Peak avoidance</strong><span>Batteries discharge during peak so you buy less at high pricing.</span></div></div>
              <div class="bItem"><div class="bIcon">üßæ</div><div class="bText"><strong>Net billing reality</strong><span>You stay connected, but you‚Äôre not forced to buy most power at peak.</span></div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 4: Outage demo + VPP links -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Outage Protection</h2>
        <div class="pill"><span class="dot"></span> Win the day ‚Ä¢ Own the night</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="videoShell">
            <div class="videoViewport">
              <video id="outageVideo" controls playsinline preload="metadata">
                <source id="outageSrc" type="video/mp4">
                Your browser can‚Äôt play this video.
              </video>
            </div>
            <div class="cap">
              <div>Backup power demo</div>
              <small>Plays inline on iPhone</small>
            </div>
          </div>

          <div>
            <div class="tagline">
              <h3>Win the day. <span class="gradText">Own the night.</span></h3>
              <p>Batteries aren‚Äôt just savings ‚Äî they give control when the grid fails.</p>
            </div>

            <div class="backupGrid">
              <div class="backupItem"><div class="bkIcon">üí°</div><div><b>Lights + outlets</b><span>Stay functional without scrambling.</span></div></div>
              <div class="backupItem"><div class="bkIcon">‚ùÑÔ∏è</div><div><b>Fridge + freezer</b><span>Protect food during longer outages.</span></div></div>
              <div class="backupItem"><div class="bkIcon">üì∂</div><div><b>Wi-Fi + charging</b><span>Phones, internet, work continuity.</span></div></div>
              <div class="backupItem"><div class="bkIcon">üõ°Ô∏è</div><div><b>Security + garage</b><span>Keep essentials online.</span></div></div>
            </div>

            <div class="vppLinks">
              <div class="vppCard">
                <div class="vppBtn hoverLift" onclick="openLinkInModal('Tesla Virtual Power Plant (VPP)','https://www.tesla.com/support/tesla-virtual-power-plant')">
                  <div class="t">Tesla Virtual Power Plant (VPP)</div>
                  <div class="d">How batteries can support the grid and create additional value. (Popup)</div>
                </div>
                <div class="vppBtn hoverLift" onclick="openLinkInModal('VPP checks (examples)','https://www.google.com/search?q=tesla+virtual+power+plant+check+example&tbm=isch')">
                  <div class="t">VPP checks (examples)</div>
                  <div class="d">Image search of check examples to show potential payouts. (Popup)</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 5: Compare tool -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Compare</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn hoverLift" type="button" onclick="setYear(1,true)">Year 1</button>
          <button class="btn hoverLift" type="button" onclick="setYear(5,true)">Year 5</button>
          <button class="btn hoverLift" type="button" onclick="setYear(10,true)">Year 10</button>
          <button class="btn hoverLift" type="button" onclick="setYear(25,true)">Year 25</button>
        </div>
      </div>

      <div class="slideBody">
        <div class="compareTop">
          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(255,59,48,.18), rgba(255,255,255,.05));">
              <div>
                <div class="label">Utility</div>
                <div class="title">Edison</div>
              </div>
              <span class="tag">Red</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly bill ($)</span><input id="uPay" inputmode="decimal" value="458"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="uEsc" inputmode="decimal" value="9"></label>
              <div class="metricLine">
                <div class="mk">25-year utility spend</div>
                <div class="mv" id="uTotal" style="color:var(--utility)">$0</div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(52,199,89,.16), rgba(255,255,255,.05));">
              <div>
                <div class="label">Option 1</div>
                <div class="title">Proposal A</div>
              </div>
              <span class="tag">Green</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly payment ($)</span><input id="aPay" inputmode="decimal" value="295"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="aEsc" inputmode="decimal" value="3.5"></label>
              <div class="metricLine">
                <div class="mk">Total savings over 25 years</div>
                <div class="mv" id="aSave" style="color:var(--opt1)">$0</div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(0,194,255,.16), rgba(255,255,255,.05));">
              <div>
                <div class="label">Option 2</div>
                <div class="title">Proposal B</div>
              </div>
              <span class="tag">Cyan</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly payment ($)</span><input id="bPay" inputmode="decimal" value="325"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="bEsc" inputmode="decimal" value="4.9"></label>
              <div class="metricLine">
                <div class="mk">Total savings over 25 years</div>
                <div class="mv" id="bSave" style="color:var(--opt2)">$0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="yearPanel">
          <div class="yearHead">
            <div class="t"><span class="spark"></span> Annual payment comparison (synced year)</div>
            <div class="yearPill"><span class="dot2"></span> Year <span id="yearPill">1</span></div>
          </div>

          <div class="yearBody">
            <div class="wheelBox">
              <div class="wheelTop">
                <div class="yearBig" id="yearBig">1</div>
                <div class="dialBtns">
                  <button class="miniBtn" type="button" onclick="nudgeYear(-1)">-1</button>
                  <button class="miniBtn" type="button" onclick="nudgeYear(1)">+1</button>
                  <button class="miniBtn" type="button" onclick="setYear(1,true)">Reset</button>
                </div>
              </div>

              <div class="wheel" aria-label="Year wheel">
                <div class="wheelList" id="wheelList"></div>
              </div>

              <div class="muted" style="font-weight:900;font-size:13px;">
                Scroll the year wheel. All 3 options update together.
              </div>
            </div>

            <div class="yearCompare">
              <div class="bigMoneyGrid">
                <div class="bigTile">
                  <div class="bk">Utility <span class="chip">Red</span></div>
                  <div class="m" style="color:var(--utility)" id="uYearPay">$0</div>
                </div>

                <div class="bigTile">
                  <div class="bk">Option 1 <span class="chip">Green</span></div>
                  <div class="m" style="color:var(--opt1)" id="aYearPay">$0</div>
                </div>

                <div class="bigTile">
                  <div class="bk">Option 2 <span class="chip">Cyan</span></div>
                  <div class="m" style="color:var(--opt2)" id="bYearPay">$0</div>
                </div>
              </div>

              <div class="yearSavings">
                <div>Best plan ‚Äî total savings over 25 years</div>
                <div class="v" id="best25">$0</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- SLIDE 6: Next Steps (timeline + company links/reviews here) -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Next Steps</h2>
        <div class="pill"><span class="dot"></span> Tap a step ‚Ä¢ show trust</div>
      </div>

      <div class="slideBody">
        <div class="timelineWrap">
          <div class="timeline" id="timeline">
            <div class="step active" data-step="0"><div class="num">1</div><div class="t">Site survey</div><div class="d">Less than 1 week</div></div>
            <div class="step" data-step="1"><div class="num">2</div><div class="t">Engineering</div><div class="d">~ 1 week</div></div>
            <div class="step" data-step="2"><div class="num">3</div><div class="t">Permits</div><div class="d">1‚Äì12 weeks</div></div>
            <div class="step" data-step="3"><div class="num">4</div><div class="t">Install</div><div class="d">1 day ‚Äì 2 weeks</div></div>
            <div class="step" data-step="4"><div class="num">5</div><div class="t">Final inspection</div><div class="d">1‚Äì2 weeks</div></div>
            <div class="step" data-step="5"><div class="num">6</div><div class="t">PTO</div><div class="d">30‚Äì60 days</div></div>
          </div>

          <div class="rightStack">
            <div class="panel">
              <h3 id="stepTitle">Site survey</h3>
              <p id="stepBody">We verify roof measurements, electrical details, and battery placement so the final design matches your home exactly. This prevents surprises and keeps the project moving.</p>
              <div class="tip" id="stepTip">Why it matters: accuracy here reduces delays later.</div>
              <div class="tip" style="border-color: rgba(58,173,187,.28); background: rgba(58,173,187,.10);">
                First payment: typically 1 month after PTO (Permission To Operate).
              </div>
            </div>

            <div class="panel">
              <h3>Websites + Google reviews</h3>
              <p>Open each website and reviews in-page (popup), so you never leave this presentation.</p>

              <div class="siteGrid">
                <div class="siteRow">
                  <div class="name">SunUp Energy</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" onclick="openLinkInModal('SunUp Energy','https://www.sunup-energy.com')">Website</button>
                    <button class="btn small hoverLift" type="button" onclick="openLinkInModal('SunUp Energy Reviews','https://www.google.com/search?q=SunUp+Energy+Reviews')">Reviews</button>
                  </div>
                </div>

                <div class="siteRow">
                  <div class="name">Fulfill Power</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" onclick="openLinkInModal('Fulfill Power','https://fulfillpower.com')">Website</button>
                    <button class="btn small hoverLift" type="button" onclick="openLinkInModal('Fulfill Power Reviews','https://www.google.com/search?q=Fulfill+Power+reviews')">Reviews</button>
                  </div>
                </div>

                <div class="siteRow">
                  <div class="name">Energy Time Solar</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" onclick="openLinkInModal('Energy Time Solar','https://energytimesolar.com')">Website</button>
                    <button class="btn small hoverLift" type="button" onclick="openLinkInModal('Energy Time Solar Reviews','https://www.google.com/search?q=Energy+Time+Solar+reviews')">Reviews</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </section>

  </div>
</div>

<div class="presentBar">
  <div class="presentShell">
    <button class="btn hoverLift" id="btnPrev" type="button">Prev</button>
    <button class="btn hoverLift" id="btnStart" type="button">Start</button>
    <button class="btn primary hoverLift" id="btnNext" type="button">Next</button>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="modalBox">
    <div class="modalTop">
      <div class="title" id="modalTitle">Preview</div>
      <div class="modalActions">
        <button class="iconBtn" id="zoomOut" type="button" title="Zoom out">‚àí</button>
        <button class="iconBtn" id="zoomIn" type="button" title="Zoom in">+</button>
        <button class="iconBtn" id="zoomFit" type="button" title="Fit">Fit</button>
        <button class="iconBtn" id="modalClose" type="button" title="Close">Close</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="viewer" id="viewer" style="display:none;">
        <div class="viewerCanvas" id="viewerCanvas">
          <img id="viewerImg" alt="Preview"/>
        </div>
        <div class="zoomBar">
          <div class="zoomRange">
            <input id="zoomRange" type="range" min="0.8" max="3.0" step="0.05" value="1.2" aria-label="Zoom"/>
          </div>
        </div>
      </div>

      <div class="frame" id="frame" style="display:none;">
        <iframe id="frameIframe" title="Popup"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Assets ========= */
const ASSETS = {
  logo: "4A5B0E0C-50D9-4752-8469-F61A667110D8.png",
  billUtility: "Scebill.jpeg",
  billSolar: "IMG_9100.jpeg",
  outageVideo: "Outagevideo.mp4"
};

/* iOS detection */
(function(){
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  if(isIOS) document.documentElement.classList.add("ios");
})();

/* Init assets */
document.getElementById("logoImg").src = ASSETS.logo;

const imgUtilityBill = document.getElementById("imgUtilityBill");
const imgSolarBill = document.getElementById("imgSolarBill");
imgUtilityBill.src = ASSETS.billUtility;
imgSolarBill.src = ASSETS.billSolar;

imgUtilityBill.addEventListener("click", () => openImageInModal("Today‚Äôs bill (no solar)", ASSETS.billUtility));
imgSolarBill.addEventListener("click", () => openImageInModal("Solar + storage bill example ($28)", ASSETS.billSolar));

const outageVideo = document.getElementById("outageVideo");
document.getElementById("outageSrc").src = ASSETS.outageVideo;
outageVideo.load();

/* Slides */
const slides = Array.from(document.querySelectorAll("[data-slide]"));
let idx = 0;
function show(i){
  idx = Math.max(0, Math.min(slides.length - 1, i));
  slides.forEach((s, n) => s.classList.toggle("active", n === idx));
  const pct = ((idx) / (slides.length - 1)) * 100;
  document.getElementById("progressFill").style.width = (isFinite(pct)?pct:0) + "%";
  if(outageVideo && idx !== 3){ try{ outageVideo.pause(); }catch(e){} }
}
function go(i){ show(i); }
function next(){ show(idx + 1); }
function prev(){ show(idx - 1); }
function start(){ show(0); }

document.getElementById("btnPrev").addEventListener("click", prev);
document.getElementById("btnNext").addEventListener("click", next);
document.getElementById("btnStart").addEventListener("click", start);

document.getElementById("btnHome").addEventListener("click", start);
document.getElementById("btnPrevTop").addEventListener("click", prev);
document.getElementById("btnNextTop").addEventListener("click", next);
document.getElementById("btnReset").addEventListener("click", resetAll);

/* Fullscreen */
document.getElementById("btnFS").addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){}
});

/* Keyboard */
window.addEventListener("keydown", (e)=>{
  if(e.key === "ArrowRight" || e.key === "PageDown" || e.key === " "){ e.preventDefault(); next(); }
  if(e.key === "ArrowLeft" || e.key === "PageUp"){ e.preventDefault(); prev(); }
  if(e.key === "Home"){ e.preventDefault(); start(); }
  if(e.key === "Escape" && modal.classList.contains("show")) closeModal();
});

/* ========= Helpers ========= */
function num(v, fallback=0){
  const x = parseFloat(String(v).replace(/[^0-9.\-]/g,""));
  return isFinite(x) ? x : fallback;
}
function money(x){
  const n = isFinite(x) ? x : 0;
  return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
}
function money2(x){
  const n = isFinite(x) ? x : 0;
  return n.toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});
}

/* ========= Slide 1: customer $/kWh ========= */
const custMonthly = document.getElementById("custMonthly");
const custUsage = document.getElementById("custUsage");
const custCpkwh = document.getElementById("custCpkwh");

function recalcCustomer(){
  const m = num(custMonthly.value, 458);
  const kwh = Math.max(0, num(custUsage.value, 12000));
  const annual = m * 12;
  const cpk = (kwh > 0) ? (annual / kwh) : 0;
  custCpkwh.textContent = "$" + (cpk || 0).toFixed(2);
}
custMonthly.addEventListener("input", ()=>{ recalcCustomer(); syncUtilityFromCustomer(true); });
custUsage.addEventListener("input", recalcCustomer);

/* ========= Calculator + wheel ========= */
const uPay = document.getElementById("uPay");
const uEsc = document.getElementById("uEsc");
const aPay = document.getElementById("aPay");
const aEsc = document.getElementById("aEsc");
const bPay = document.getElementById("bPay");
const bEsc = document.getElementById("bEsc");

const uTotal = document.getElementById("uTotal");
const aSave = document.getElementById("aSave");
const bSave = document.getElementById("bSave");

const yearPill = document.getElementById("yearPill");
const yearBig = document.getElementById("yearBig");

const uYearPay = document.getElementById("uYearPay");
const aYearPay = document.getElementById("aYearPay");
const bYearPay = document.getElementById("bYearPay");
const best25 = document.getElementById("best25");

let currentYear = 1;
const years = 25;

function yearlyMonthly(base, escPct, year){
  const r = escPct/100;
  return base * Math.pow(1+r, Math.max(0, year-1));
}
function sum25(baseMonthly, escPct){
  let sum = 0;
  for(let y=1;y<=years;y++){
    sum += yearlyMonthly(baseMonthly, escPct, y) * 12;
  }
  return sum;
}
function recalc(){
  const U = num(uPay.value, 458);
  const UE = num(uEsc.value, 9);
  const A = num(aPay.value, 295);
  const AE = num(aEsc.value, 3.5);
  const B = num(bPay.value, 325);
  const BE = num(bEsc.value, 4.9);

  const U25 = sum25(U, UE);
  const A25 = sum25(A, AE);
  const B25 = sum25(B, BE);

  const saveA = Math.max(0, U25 - A25);
  const saveB = Math.max(0, U25 - B25);

  uTotal.textContent = money(U25);
  aSave.textContent = money(saveA);
  bSave.textContent = money(saveB);

  const Um = yearlyMonthly(U, UE, currentYear);
  const Am = yearlyMonthly(A, AE, currentYear);
  const Bm = yearlyMonthly(B, BE, currentYear);

  uYearPay.textContent = money2(Um);
  aYearPay.textContent = money2(Am);
  bYearPay.textContent = money2(Bm);

  best25.textContent = money(Math.max(saveA, saveB));
}
[uPay,uEsc,aPay,aEsc,bPay,bEsc].forEach(el=>{
  el.addEventListener("input", recalc);
  el.addEventListener("change", recalc);
});

function syncUtilityFromCustomer(silent=false){
  uPay.value = String(num(custMonthly.value, 458));
  if(!silent) recalc();
  else recalc();
}

function setYear(y, snapWheel=false){
  currentYear = Math.max(1, Math.min(years, y));
  yearPill.textContent = String(currentYear);
  yearBig.textContent = String(currentYear);
  highlightWheel();
  recalc();
  if(snapWheel) snapWheelToYear(currentYear);
}
function nudgeYear(delta){ setYear(currentYear + delta, true); }

const wheelList = document.getElementById("wheelList");
(function buildWheel(){
  const frag = document.createDocumentFragment();
  for(let y=1;y<=years;y++){
    const div = document.createElement("div");
    div.className = "wheelItem";
    div.dataset.year = String(y);
    div.textContent = "Year " + y;
    div.addEventListener("click", ()=> setYear(y, true));
    frag.appendChild(div);
  }
  wheelList.appendChild(frag);
  wheelList.addEventListener("scroll", onWheelScroll, {passive:true});
  setTimeout(()=>{ setYear(1,true); }, 0);
})();
let wheelScrollTimer = null;
function onWheelScroll(){
  if(wheelScrollTimer) clearTimeout(wheelScrollTimer);
  wheelScrollTimer = setTimeout(()=>{
    const items = Array.from(wheelList.querySelectorAll(".wheelItem"));
    const rect = wheelList.getBoundingClientRect();
    const centerY = rect.top + rect.height/2;

    let best = null, bestDist = Infinity;
    for(const it of items){
      const r = it.getBoundingClientRect();
      const itCenter = r.top + r.height/2;
      const d = Math.abs(itCenter - centerY);
      if(d < bestDist){ bestDist = d; best = it; }
    }
    if(best){
      const y = parseInt(best.dataset.year,10);
      setYear(y,false);
    }
  }, 90);
}
function highlightWheel(){
  wheelList.querySelectorAll(".wheelItem")
    .forEach(it => it.classList.toggle("active", parseInt(it.dataset.year,10) === currentYear));
}
function snapWheelToYear(y){
  const target = wheelList.querySelector(`.wheelItem[data-year="${y}"]`);
  if(!target) return;
  target.scrollIntoView({block:"center", behavior: document.documentElement.classList.contains("ios") ? "auto" : "smooth"});
}

/* ========= Next Steps timeline ========= */
const stepTitle = document.getElementById("stepTitle");
const stepBody  = document.getElementById("stepBody");
const stepTip   = document.getElementById("stepTip");

const stepData = [
  {title:"Site survey", body:"We verify roof measurements, electrical details, and battery placement so the final design matches your home exactly. This prevents surprises and keeps the project moving.", tip:"Why it matters: accuracy here reduces delays later."},
  {title:"Engineering", body:"Your system is designed to code and finalized for the roof, electrical, and utility requirements. This turns the concept into a build-ready plan.", tip:"Why it matters: clean engineering speeds up permits and reduces change orders."},
  {title:"Permits", body:"The city reviews and approves the plans. Timelines vary by city workload and specific requirements.", tip:"Why it matters: this is the widest time range step‚Äîtracking is key."},
  {title:"Install", body:"Solar and batteries are installed. Some homes are completed quickly; larger projects can take longer based on scope and scheduling.", tip:"Why it matters: once installed, you‚Äôre close to inspection and PTO."},
  {title:"Final inspection", body:"The city/authority verifies the installation matches the approved plans and meets code.", tip:"Why it matters: passing inspection is required before the utility grants PTO."},
  {title:"PTO (Permission To Operate)", body:"The utility grants permission to operate/export fully. This step typically takes 30‚Äì60 days after inspection depending on utility processing.", tip:"Why it matters: PTO is the official go-live milestone."}
];

document.getElementById("timeline").addEventListener("click", (e)=>{
  const step = e.target.closest(".step");
  if(!step) return;
  const i = parseInt(step.dataset.step,10);
  document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
  step.classList.add("active");
  const d = stepData[i] || stepData[0];
  stepTitle.textContent = d.title;
  stepBody.textContent = d.body;
  stepTip.textContent = d.tip;
});

/* ========= Modal functions ========= */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalClose = document.getElementById("modalClose");
const viewer = document.getElementById("viewer");
const viewerCanvas = document.getElementById("viewerCanvas");
const viewerImg = document.getElementById("viewerImg");
const zoomRange = document.getElementById("zoomRange");
const zoomOut = document.getElementById("zoomOut");
const zoomIn = document.getElementById("zoomIn");
const zoomFit = document.getElementById("zoomFit");
const frame = document.getElementById("frame");
const frameIframe = document.getElementById("frameIframe");

let viewScale = 1.2, imgW = 0, imgH = 0, panX = 0, panY = 0;
let dragging = false, startX = 0, startY = 0, startPanX = 0, startPanY = 0;

function openModal(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); }
function closeModal(){
  modal.classList.remove("show"); modal.setAttribute("aria-hidden","true");
  frameIframe.src = "about:blank";
  viewerImg.src = "";
}
modalClose.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

function openImageInModal(title, src){
  modalTitle.textContent = title;
  frame.style.display = "none";
  viewer.style.display = "block";
  viewerImg.onload = ()=>{
    imgW = viewerImg.naturalWidth;
    imgH = viewerImg.naturalHeight;
    fitToView();
  };
  viewerImg.src = src;
  openModal();
}
function openLinkInModal(title, url){
  modalTitle.textContent = title;
  viewer.style.display = "none";
  frame.style.display = "block";
  frameIframe.src = url;
  openModal();
}
function applyTransform(){
  const s = Math.max(0.8, Math.min(3.0, viewScale));
  viewScale = s;
  zoomRange.value = String(s);
  viewerImg.style.transform = `translate(${panX}px, ${panY}px) scale(${s})`;
}
function fitToView(){
  const box = viewerCanvas.getBoundingClientRect();
  if(!imgW || !imgH || !box.width || !box.height){
    viewScale = 1.2; panX = 0; panY = 0; applyTransform(); return;
  }
  const sx = (box.width - 24) / imgW;
  const sy = (box.height - 24) / imgH;
  const fit = Math.min(sx, sy);
  viewScale = Math.max(0.9, Math.min(1.6, fit * 1.15));
  panX = Math.max(12, (box.width - imgW * viewScale)/2);
  panY = Math.max(12, (box.height - imgH * viewScale)/2);
  applyTransform();
}

viewerCanvas.addEventListener("pointerdown", (e)=>{
  dragging = true;
  viewerCanvas.classList.add("grabbing");
  viewerCanvas.setPointerCapture(e.pointerId);
  startX = e.clientX; startY = e.clientY;
  startPanX = panX; startPanY = panY;
});
viewerCanvas.addEventListener("pointermove", (e)=>{
  if(!dragging) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  panX = startPanX + dx;
  panY = startPanY + dy;
  applyTransform();
});
viewerCanvas.addEventListener("pointerup", ()=>{
  dragging = false;
  viewerCanvas.classList.remove("grabbing");
});
viewerCanvas.addEventListener("pointercancel", ()=>{
  dragging = false;
  viewerCanvas.classList.remove("grabbing");
});

zoomRange.addEventListener("input", ()=>{ viewScale = parseFloat(zoomRange.value); applyTransform(); });
zoomIn.addEventListener("click", ()=>{ viewScale = Math.min(3.0, viewScale + 0.15); applyTransform(); });
zoomOut.addEventListener("click", ()=>{ viewScale = Math.max(0.8, viewScale - 0.15); applyTransform(); });
zoomFit.addEventListener("click", fitToView);

/* Reset */
function resetAll(){
  custMonthly.value = "458";
  custUsage.value = "12000";
  recalcCustomer();

  uPay.value = "458"; uEsc.value = "9";
  aPay.value = "295"; aEsc.value = "3.5";
  bPay.value = "325"; bEsc.value = "4.9";
  setYear(1,true); show(0); recalc();
}

/* Init */
recalcCustomer();
syncUtilityFromCustomer(true);
setYear(1,true);
recalc();
show(0);
</script>

</body>
</html>
