<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Solar + Storage Closing Tool</title>
<meta name="theme-color" content="#0b1017"/>

<style>
  :root{
    --navy:#0b1017;
    --navy2:#06122a;
    --gold:#FBC909;
    --teal:#3AADBB;

    --utility:#ff3b30; /* red */
    --opt1:#34c759;    /* green */
    --opt2:#00c2ff;    /* cyan */

    --text:rgba(255,255,255,.96);
    --muted:rgba(255,255,255,.72);
    --muted2:rgba(255,255,255,.56);
    --border:rgba(255,255,255,.14);

    --grad:linear-gradient(135deg,var(--gold),var(--teal));
    --shadow: 0 18px 70px rgba(0,0,0,.45);

    --r:16px;
    --r2:22px;

    --safeT: env(safe-area-inset-top);
    --safeB: env(safe-area-inset-bottom);
    --safeL: env(safe-area-inset-left);
    --safeR: env(safe-area-inset-right);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 460px at 14% 10%, rgba(251,201,9,.18), transparent 60%),
      radial-gradient(900px 460px at 86% 12%, rgba(58,173,187,.16), transparent 60%),
      linear-gradient(180deg, var(--navy2), var(--navy));
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  html.ios .luxShadow{ box-shadow:none !important; }
  html.ios .hoverLift:hover{ transform:none !important; box-shadow:none !important; }
  html.ios .slide{ transition:none !important; }

  button, a, input { -webkit-tap-highlight-color: transparent; }
  a{color:#cfe8ff;text-decoration:none}
  a:hover{text-decoration:underline}

  /* ===== Top Bar ===== */
  .topbar{
    position:fixed; inset:0 0 auto 0;
    z-index:120;
    padding-top:var(--safeT);
    background: rgba(10,16,24,.88);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .topbarInner{
    max-width:1280px;
    margin:0 auto;
    padding:10px 14px;
    padding-left: calc(14px + var(--safeL));
    padding-right: calc(14px + var(--safeR));
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:12px; min-width:180px; overflow:hidden;}
  .brand img{height:54px; width:auto; display:block; filter:drop-shadow(0 12px 28px rgba(0,0,0,.35));}
  .brandTitle{min-width:0}
  .brandTitle .name{
    font-weight:1000; letter-spacing:-.02em;
    display:flex; align-items:center; gap:10px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .brandTitle .sub{font-size:12px; color:var(--muted2); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .dot{
    width:10px;height:10px;border-radius:999px;background:var(--grad);
    box-shadow:0 0 0 6px rgba(251,201,9,.10), 0 0 26px rgba(58,173,187,.18);
    flex:0 0 auto;
  }

  .navTop{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
  .btn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:950;
    cursor:pointer;
    min-height:42px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    user-select:none;
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .btn.hoverLift:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.10);
    box-shadow: 0 14px 44px rgba(0,0,0,.25);
    border-color: rgba(255,255,255,.18);
  }
  .btn.primary{
    background: var(--grad);
    color:#07121b;
    border-color: rgba(255,255,255,.18);
    box-shadow: 0 18px 58px rgba(58,173,187,.14), 0 18px 58px rgba(251,201,9,.10);
  }
  .btn.danger{border-color: rgba(255,59,48,.25); background: rgba(255,59,48,.10);}
  .btn.icon{min-width:46px}
  @media (max-width:860px){
    .brandTitle .sub{display:none}
    .btn.hideMobile{display:none}
  }

  .progressWrap{
    max-width:1280px; margin:0 auto;
    padding: 0 14px 10px;
    padding-left: calc(14px + var(--safeL));
    padding-right: calc(14px + var(--safeR));
  }
  .progress{
    height:7px;border-radius:999px;background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);overflow:hidden;
  }
  .progress > div{height:100%; width:0%; background:var(--grad); transition: width .18s ease;}

  /* ===== Deck ===== */
  .deck{
    height:100%;
    padding-top: calc(86px + var(--safeT));
    padding-bottom: calc(86px + var(--safeB));
    display:flex; align-items:stretch; justify-content:center;
  }
  .stage{
    width:min(1280px, 100vw);
    height:100%;
    padding: 14px 16px;
    padding-left: calc(16px + var(--safeL));
    padding-right: calc(16px + var(--safeR));
    position:relative;
  }
  .slide{
    position:absolute;
    inset:14px 16px;
    inset-left: calc(16px + var(--safeL));
    inset-right: calc(16px + var(--safeR));
    border:1px solid rgba(255,255,255,.14);
    border-radius: var(--r2);
    background: rgba(255,255,255,.05);
    overflow:hidden;
    opacity:0;
    transform: translateY(10px) scale(.99);
    pointer-events:none;
    transition: opacity .16s ease, transform .16s ease;
  }
  .slide.active{opacity:1; transform: translateY(0) scale(1); pointer-events:auto;}
  .luxShadow{ box-shadow: var(--shadow); }

  .slideHead{
    padding:16px 18px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .slideHead h2{
    margin:0;
    font-size: 15px;
    letter-spacing:.04em;
    text-transform:uppercase;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .spark{width:10px;height:10px;border-radius:999px;background:var(--grad); box-shadow:0 0 22px rgba(251,201,9,.16), 0 0 22px rgba(58,173,187,.14);}

  .slideBody{
    padding:18px;
    height: calc(100% - 58px);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Bottom presentation controls */
  .presentBar{
    position:fixed;
    left: 12px;
    right: 12px;
    bottom: calc(12px + var(--safeB));
    z-index:140;
    display:flex;
    justify-content:center;
    pointer-events:none;
  }
  .presentShell{
    pointer-events:auto;
    width:min(980px,100%);
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.24);
    border-radius:18px;
    padding:10px;
  }
  .presentShell .btn{flex:1; min-height:46px;}
  .presentShell .btn.primary{flex:1.2;}
  @media (max-width:520px){
    .presentShell{gap:8px;padding:8px}
    .presentShell .btn{min-height:44px;padding:10px 10px}
  }

  /* Layout helpers */
  .grid{display:grid; gap:14px;}
  .grid2{grid-template-columns: 1.05fr .95fr;}
  @media (max-width:980px){ .grid2{grid-template-columns:1fr;} }

  .pill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:10px 12px;
    font-weight:950;
    color: rgba(255,255,255,.88);
    display:inline-flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
  }

  .gradText{
    background:var(--grad);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    font-weight:1000;
  }

  /* Slide 1 (simple start) */
  .centerStage{height:100%;display:grid;place-items:center;}
  .heroCard{
    width:min(980px,100%);
    border:1px solid rgba(255,255,255,.14);
    border-radius:22px;
    background:
      radial-gradient(740px 340px at 20% 20%, rgba(251,201,9,.14), transparent 62%),
      radial-gradient(740px 340px at 80% 20%, rgba(58,173,187,.12), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    padding:18px;
  }
  html.ios .heroCard{background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
  .heroTop{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .heroTop h1{
    margin:0;
    font-size: clamp(28px, 4.2vw, 56px);
    letter-spacing:-.055em;
    line-height:1.02;
  }
  .heroSub{margin-top:10px;color:var(--muted);font-weight:900;font-size:15px;line-height:1.5;}
  .klabel{
    display:block;color:rgba(255,255,255,.78);
    font-weight:1000;font-size:11px;letter-spacing:.12em;
    text-transform:uppercase;margin-bottom:6px;
  }
  input{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
    color: rgba(255,255,255,.96);
    font-weight:1000;
    font-size:16px;
    outline:none;
    min-height:44px;
  }
  input:focus{
    border-color: rgba(58,173,187,.72);
    box-shadow: 0 0 0 6px rgba(58,173,187,.12);
  }
  html.ios input:focus{box-shadow:none;}
  .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
  @media (max-width:980px){.formGrid{grid-template-columns:1fr;}}
  .metricRow{
    margin-top:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);
    border-radius:18px;padding:14px;display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;
  }
  .metricRow .mk{color:rgba(255,255,255,.70);font-weight:1000;font-size:11px;letter-spacing:.12em;text-transform:uppercase;}
  .metricRow .mv{font-weight:1000;font-size: clamp(26px, 3.6vw, 42px);letter-spacing:-.04em;}
  .metricRow .mv.red{color:var(--utility);}

  /* Bills (open inside overlay) */
  .billFrame{border:1px solid rgba(255,255,255,.14);border-radius:18px;background:rgba(0,0,0,.16);overflow:hidden;}
  .billViewport{height:clamp(260px,42vh,520px);background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .billViewport img{width:100%;height:100%;object-fit:contain;display:block;cursor:pointer;background:#000;}
  .cap{padding:12px 14px;border-top:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;gap:10px;align-items:center;background:rgba(0,0,0,.14);font-weight:1000;}
  .cap small{color:var(--muted2);font-weight:900;white-space:nowrap;}

  /* Link buttons (open new tab) */
  .linkBtns{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px;}
  @media (max-width:980px){.linkBtns{grid-template-columns:1fr;}}
  .linkBtn{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    padding:14px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    display:flex;flex-direction:column;gap:10px;
  }
  .linkBtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18);}
  .linkTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
  .capTag{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:1000;
    font-size:12px;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
  }
  .linkTitle{font-weight:1000;letter-spacing:-.02em;font-size:18px;line-height:1.12;}
  .linkDesc{color:var(--muted);font-weight:900;font-size:13.5px;line-height:1.4;}

  /* Explanation box */
  .headlineBox{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(0,0,0,.16);
    padding:16px;
  }
  .headlineBox .big{
    margin:0 0 10px;
    font-size: clamp(22px, 3.1vw, 40px);
    font-weight:1000;
    letter-spacing:-.045em;
    line-height:1.06;
  }
  .headlineBox .sub{
    margin:0;
    color:var(--muted);
    font-weight:900;
    font-size:15px;
    line-height:1.45;
  }
  .bullets{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(255,255,255,.05);
    padding:16px;
    display:grid;
    gap:12px;
    margin-top:12px;
  }
  .bItem{
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    background: rgba(0,0,0,.14);
    padding:12px;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .bIcon{
    width:34px;height:34px;border-radius:12px;
    background: var(--grad);
    color:#07121b;
    font-weight:1000;
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  }
  .bText strong{font-weight:1000; letter-spacing:-.02em;}
  .bText span{display:block; margin-top:3px; color:var(--muted); font-weight:850; font-size:13.5px; line-height:1.35;}

  /* Video */
  .videoShell{border:1px solid rgba(255,255,255,.14);border-radius:18px;overflow:hidden;background:rgba(0,0,0,.22);}
  .videoViewport{width:100%;height:clamp(260px,46vh,520px);background:#000;}
  video{width:100%;height:100%;object-fit:contain;display:block;background:#000;}
  .tagline{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: linear-gradient(135deg, rgba(251,201,9,.11), rgba(58,173,187,.09));
    padding:14px;
  }
  .tagline h3{margin:0;font-size: clamp(18px, 2.4vw, 28px);letter-spacing:-.03em;font-weight:1000;}
  .tagline p{margin:8px 0 0;color:var(--muted);font-weight:900;line-height:1.45;}
  .backupGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
  @media (max-width:980px){.backupGrid{grid-template-columns:1fr;}}
  .backupItem{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);border-radius:18px;padding:12px;display:flex;gap:12px;align-items:flex-start;}
  .bkIcon{width:36px;height:36px;border-radius:14px;background:var(--grad);color:#07121b;display:flex;align-items:center;justify-content:center;font-weight:1000;flex:0 0 auto;}
  .backupItem b{display:block;font-weight:1000}
  .backupItem span{display:block;margin-top:3px;color:var(--muted);font-weight:900;font-size:13.5px;line-height:1.35;}

  /* Compare tool */
  .compareTop{display:grid; grid-template-columns: repeat(3,1fr); gap:12px;}
  @media (max-width:980px){ .compareTop{grid-template-columns:1fr;} }
  .col{
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    background: rgba(255,255,255,.04);
    overflow:hidden;
  }
  .colHead{
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }
  .colHead .label{color:var(--muted2); font-weight:1000; font-size:11px; letter-spacing:.12em; text-transform:uppercase;}
  .colHead .title{margin-top:2px; font-weight:1000; font-size:18px; letter-spacing:-.02em;}
  .tag{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:950;
    font-size:12px;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
  }
  .colBody{padding:14px; display:grid; gap:10px;}
  .metricLine{
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .metricLine .mk{color:var(--muted2); font-weight:950; font-size:11px; letter-spacing:.12em; text-transform:uppercase;}
  .metricLine .mv{font-weight:1000; font-size:18px;}

  /* Year wheel */
  .yearPanel{
    margin-top:14px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:22px;
    background: rgba(255,255,255,.04);
    overflow:hidden;
  }
  .yearHead{
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: linear-gradient(135deg, rgba(251,201,9,.11), rgba(58,173,187,.09));
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .yearHead .t{font-weight:1000; letter-spacing:-.02em; display:flex; align-items:center; gap:10px;}
  .yearPill{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:8px 10px;
    font-weight:1000;
    display:flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
  }
  .yearPill .dot2{width:10px;height:10px;border-radius:999px;background:var(--grad);}
  .yearBody{
    padding:16px;
    display:grid;
    grid-template-columns: .9fr 1.1fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:980px){ .yearBody{grid-template-columns:1fr;} }

  .wheelBox{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    display:grid;
    gap:12px;
  }
  .wheelTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
  .yearBig{font-size: clamp(46px, 6.6vw, 78px); font-weight:1000; letter-spacing:-.05em; line-height:1;}
  .dialBtns{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .miniBtn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    min-height:44px;
    cursor:pointer;
  }
  .wheel{
    position:relative;
    height:220px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    overflow:hidden;
  }
  .wheel::before{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(180deg, rgba(11,16,23,.92), transparent 26%, transparent 74%, rgba(11,16,23,.92));
    pointer-events:none;
    z-index:2;
  }
  .wheel::after{
    content:"";
    position:absolute;
    left:10px; right:10px;
    top: calc(50% - 22px);
    height:44px;
    border-radius:14px;
    border:1px solid rgba(251,201,9,.24);
    box-shadow: 0 0 0 6px rgba(58,173,187,.10);
    pointer-events:none;
    z-index:3;
  }
  html.ios .wheel::after{ box-shadow:none; }

  .wheelList{
    height:100%;
    overflow-y:auto;
    scroll-snap-type:y mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 88px 0;
    margin:0;
  }
  .wheelList::-webkit-scrollbar{ width: 0; height:0; }
  .wheelItem{
    height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
    scroll-snap-align:center;
    font-weight:1000;
    font-size:20px;
    letter-spacing:-.01em;
    color: rgba(255,255,255,.72);
    user-select:none;
  }
  .wheelItem.active{
    color: rgba(255,255,255,.96);
    text-shadow: 0 10px 32px rgba(0,0,0,.35);
  }

  .yearCompare{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    display:grid;
    gap:12px;
  }
  .bigMoneyGrid{display:grid; grid-template-columns: repeat(3,1fr); gap:10px;}
  @media (max-width:980px){ .bigMoneyGrid{grid-template-columns:1fr;} }
  .bigTile{
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    border-radius:18px;
    padding:12px;
  }
  .bigTile .bk{
    color:var(--muted2);
    font-weight:1000;
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .chip{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
    font-weight:950;
    color: rgba(255,255,255,.86);
    white-space:nowrap;
    font-size:12px;
  }
  .bigTile .m{
    margin-top:10px;
    font-size: clamp(34px, 5.4vw, 58px);
    font-weight:1000;
    letter-spacing:-.035em;
    line-height:1;
  }
  .kwhLine{
    margin-top:8px;
    font-weight:1000;
    font-size:14px;
    letter-spacing:-.01em;
    color: rgba(255,255,255,.92); /* brighter than section */
  }
  .kwhLine .u{color:rgba(255,255,255,.92);}
  .kwhLine .unit{color:rgba(255,255,255,.72); font-weight:900;}
  .yearSavings{
    border:1px solid rgba(52,199,89,.28);
    background: rgba(52,199,89,.10);
    border-radius:16px;
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    font-weight:1000;
  }
  .yearSavings .v{font-size:18px; color: var(--opt1); letter-spacing:-.01em;}

  /* Next Steps + companies */
  .timelineWrap{display:grid;grid-template-columns:1.05fr .95fr;gap:12px;align-items:stretch;}
  @media (max-width:980px){.timelineWrap{grid-template-columns:1fr;}}
  .timeline{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  @media (max-width:980px){.timeline{grid-template-columns:1fr;}}
  .step{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:14px;
    min-height:112px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .step:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18);}
  .step.active{border-color:rgba(58,173,187,.55);background:rgba(58,173,187,.10);}
  .num{
    width:30px;height:30px;border-radius:12px;background:var(--grad);color:#07121b;
    display:flex;align-items:center;justify-content:center;font-weight:1000;margin-bottom:10px;
  }
  .step .t{font-weight:1000}
  .step .d{margin-top:8px;color:rgba(255,255,255,.78);font-weight:900;font-size:13.5px;line-height:1.35}
  .rightStack{display:grid;gap:12px}
  .panel{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:18px;
    padding:16px;
  }
  .panel h3{margin:0;font-size: clamp(18px, 2.2vw, 28px);letter-spacing:-.03em;font-weight:1000;}
  .panel p{margin:10px 0 0;color:var(--muted);font-weight:900;line-height:1.5;}
  .tip{
    margin-top:12px;
    border:1px solid rgba(251,201,9,.22);
    background: rgba(251,201,9,.08);
    border-radius:16px;
    padding:12px;
    font-weight:1000;
    color:rgba(255,255,255,.92);
  }
  .tip.alt{border-color:rgba(58,173,187,.28);background:rgba(58,173,187,.10);}

  .siteGrid{display:grid;gap:10px;margin-top:12px;}
  .siteRow{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.14);
    border-radius:18px;
    padding:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .siteRow .name{font-weight:1000}
  .siteRow .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn.small{min-height:40px;padding:9px 10px}
  .btn.linkish{border-color:rgba(58,173,187,.22); background:rgba(58,173,187,.10);}

  /* Overlay image viewer (in-page magnifier) */
  .overlay{
    position:fixed; inset:0;
    z-index:300;
    display:none;
    background:rgba(0,0,0,.78);
    padding: calc(14px + var(--safeT)) calc(14px + var(--safeR)) calc(14px + var(--safeB)) calc(14px + var(--safeL));
  }
  .overlay.show{display:block}
  .overlayBox{
    width:min(1100px,100%);
    height:min(86vh,900px);
    margin:0 auto;
    border:1px solid rgba(255,255,255,.16);
    border-radius:22px;
    background: rgba(10,16,24,.94);
    overflow:hidden;
    box-shadow:0 20px 80px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
  }
  .overlayTop{
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .overlayTop .title{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
  .overlayActions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .iconBtn{
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    min-height:42px;
    cursor:pointer;
  }
  .overlayBody{position:relative;flex:1;overflow:hidden;background:#000}
  .viewerCanvas{position:absolute;inset:0;cursor:grab;touch-action:none}
  .viewerCanvas.grabbing{cursor:grabbing}
  .viewerCanvas img{
    position:absolute;top:0;left:0;
    transform-origin:0 0;
    user-select:none;-webkit-user-drag:none;
    max-width:none;max-height:none;
  }
  .zoomBar{
    position:absolute;left:12px;right:12px;bottom:12px;
    display:flex;gap:10px;align-items:center;z-index:3;pointer-events:none;
  }
  .zoomRange{
    flex:1;pointer-events:auto;height:42px;border-radius:14px;
    border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
    padding:0 10px;display:flex;align-items:center;
  }
  .zoomRange input{width:100%;height:24px;margin:0;background:transparent;border:0;padding:0;box-shadow:none;min-height:auto}
</style>
</head>

<body>

<div class="topbar">
  <div class="topbarInner">
    <div class="brand">
      <img id="logoImg" alt="Logo"/>
      <div class="brandTitle">
        <div class="name"><span class="dot"></span> Leverage Our Sun</div>
        <div class="sub">Solar + Storage Closing Tool</div>
      </div>
    </div>
    <div class="navTop">
      <button class="btn hideMobile hoverLift" id="btnHome" type="button">Home</button>
      <button class="btn hideMobile hoverLift" id="btnPrevTop" type="button">Prev</button>
      <button class="btn primary hideMobile hoverLift" id="btnNextTop" type="button">Next</button>
      <button class="btn icon hoverLift" id="btnFS" type="button" title="Fullscreen">‚õ∂</button>
      <button class="btn danger hideMobile hoverLift" id="btnReset" type="button">Reset</button>
    </div>
  </div>
  <div class="progressWrap">
    <div class="progress"><div id="progressFill"></div></div>
  </div>
</div>

<div class="deck">
  <div class="stage" id="stage">

    <!-- SLIDE 1: Start -->
    <section class="slide luxShadow active" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Start</h2>
        <div class="pill"><span class="dot"></span> Win the day ‚Ä¢ Own the night</div>
      </div>
      <div class="slideBody">
        <div class="centerStage">
          <div class="heroCard">
            <div class="heroTop">
              <h1>Win the day. <span class="gradText">Own the night.</span></h1>
              <span class="pill">Baseline</span>
            </div>
            <div class="heroSub">
              Enter the customer‚Äôs monthly average and annual usage. This calculates their current $/kWh and fills Edison in the comparison.
            </div>

            <div class="formGrid">
              <label>
                <span class="klabel">Average monthly bill ($)</span>
                <input id="custMonthly" inputmode="decimal" value="458">
              </label>
              <label>
                <span class="klabel">Annual usage (kWh)</span>
                <input id="custUsage" inputmode="decimal" value="12000">
              </label>
            </div>

            <div class="metricRow">
              <div class="mk">Today‚Äôs average cost per kWh</div>
              <div class="mv red" id="custCpkwh">$0.00</div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
              <button class="btn hoverLift" id="btnApply" type="button">Apply to calculator</button>
              <button class="btn primary hoverLift" id="btnContinue" type="button">Continue</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 2: Problem -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> The Problem</h2>
        <div class="pill"><span class="dot"></span> TOU + rate pressure</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="billFrame">
            <div class="billViewport">
              <img id="imgUtilityBill" alt="Utility bill without solar"/>
            </div>
            <div class="cap">
              <div>Today‚Äôs bill (no solar)</div>
              <small>Tap to magnify</small>
            </div>
          </div>

          <div class="headlineBox">
            <div class="big">Why rates feel brutal: <span class="gradText">Time-of-Use</span></div>
            <p class="sub">
              It‚Äôs not only how much energy you use ‚Äî it‚Äôs when you‚Äôre forced to buy it. Peak hours cost the most.
              Storage is how you stop buying peak power.
            </p>

            <div class="bullets">
              <div class="bItem"><div class="bIcon">‚è±Ô∏è</div><div class="bText"><strong>Peak pricing</strong><span>Expensive hours drive a big share of the bill.</span></div></div>
              <div class="bItem"><div class="bIcon">üìà</div><div class="bText"><strong>Ongoing pressure</strong><span>Grid upgrades + demand growth keep pushing prices.</span></div></div>
              <div class="bItem"><div class="bIcon">üîã</div><div class="bText"><strong>Battery strategy</strong><span>Shift usage away from peak by discharging stored energy.</span></div></div>
            </div>

            <div class="linkBtns">
              <div class="linkBtn" data-open-url="https://www.sce.com/save-money/rates-financing/residential-rate-plans/time-of-use-plans">
                <div class="linkTop"><span class="capTag">TOU</span><span class="capTag">Open</span></div>
                <div class="linkTitle">SCE Time-of-Use Plans</div>
                <div class="linkDesc">Official SCE TOU plan page.</div>
              </div>

              <div class="linkBtn" data-open-url="https://www.sce.com/save-money/rates-financing/residential-rate-plans/understanding-updates-to-your-bill">
                <div class="linkTop"><span class="capTag">13% increase</span><span class="capTag">Open</span></div>
                <div class="linkTitle">SCE: Understanding bill updates</div>
                <div class="linkDesc">Why bills & rate components have increased.</div>
              </div>

              <div class="linkBtn" data-open-url="https://www.latimes.com/business/story/2025-05-22/edison-general-rate-case">
                <div class="linkTop"><span class="capTag">L.A. fires</span><span class="capTag">Open</span></div>
                <div class="linkTitle">LA Times: Edison Rate Case</div>
                <div class="linkDesc">Context on continued rate pressure.</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 3: Proof ($28 bill) -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Proof</h2>
        <div class="pill"><span class="dot"></span> Solar + Storage result</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="billFrame">
            <div class="billViewport">
              <img id="imgSolarBill" alt="Solar + storage bill example"/>
            </div>
            <div class="cap">
              <div>Solar + storage bill example ($28)</div>
              <small>Tap to magnify</small>
            </div>
          </div>

          <div class="headlineBox">
            <div class="big">Why it can be <span class="gradText">$28</span></div>
            <p class="sub">
              Solar covers the day. Batteries cover the expensive hours. The grid becomes backup.
            </p>
            <div class="bullets">
              <div class="bItem"><div class="bIcon">‚òÄÔ∏è</div><div class="bText"><strong>Daytime offsets</strong><span>Less kWh purchased during daylight.</span></div></div>
              <div class="bItem"><div class="bIcon">üîã</div><div class="bText"><strong>Peak avoidance</strong><span>Batteries discharge when utility prices are highest.</span></div></div>
              <div class="bItem"><div class="bIcon">üßæ</div><div class="bText"><strong>Minimum + small net</strong><span>Often what‚Äôs left is minimum charges + small net usage.</span></div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 4: Outage demo (before calculator) -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Outage Protection</h2>
        <div class="pill"><span class="dot"></span> Win the day ‚Ä¢ Own the night</div>
      </div>

      <div class="slideBody">
        <div class="grid grid2">
          <div class="videoShell">
            <div class="videoViewport">
              <video id="outageVideo" controls playsinline preload="metadata">
                <source id="outageSrc" type="video/mp4">
              </video>
            </div>
            <div class="cap"><div>Backup power demo</div><small>Plays inline on iPhone</small></div>
          </div>

          <div>
            <div class="tagline">
              <h3>Win the day. <span class="gradText">Own the night.</span></h3>
              <p>Same batteries that save money also keep your home running when the grid goes down.</p>
            </div>

            <div class="backupGrid">
              <div class="backupItem"><div class="bkIcon">üí°</div><div><b>Lights + outlets</b><span>Keep essentials powered.</span></div></div>
              <div class="backupItem"><div class="bkIcon">‚ùÑÔ∏è</div><div><b>Fridge + freezer</b><span>Protect food during outages.</span></div></div>
              <div class="backupItem"><div class="bkIcon">üì∂</div><div><b>Wi-Fi + charging</b><span>Phones, internet, work continuity.</span></div></div>
              <div class="backupItem"><div class="bkIcon">üõ°Ô∏è</div><div><b>Security + garage</b><span>Stay safe and functional.</span></div></div>
            </div>

            <!-- Tesla VPP links (open external) -->
            <div class="linkBtns" style="margin-top:12px;">
              <div class="linkBtn" data-open-url="https://www.google.com/search?q=tesla+virtual+power+plant">
                <div class="linkTop"><span class="capTag">Tesla VPP</span><span class="capTag">Open</span></div>
                <div class="linkTitle">Tesla Virtual Power Plant</div>
                <div class="linkDesc">Program overview (search results open reliably).</div>
              </div>
              <div class="linkBtn" data-open-url="https://www.google.com/search?q=tesla+virtual+power+plant+payments+checks">
                <div class="linkTop"><span class="capTag">Checks</span><span class="capTag">Open</span></div>
                <div class="linkTitle">VPP Earnings / Check Examples</div>
                <div class="linkDesc">What customers can earn for supporting the grid.</div>
              </div>
              <div class="linkBtn" data-open-url="https://www.google.com/search?q=tesla+virtual+power+plant+california">
                <div class="linkTop"><span class="capTag">CA</span><span class="capTag">Open</span></div>
                <div class="linkTitle">VPP in California</div>
                <div class="linkDesc">Availability + how it works locally.</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- SLIDE 5: Calculator -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Compare</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn hoverLift" type="button" data-year="1">Year 1</button>
          <button class="btn hoverLift" type="button" data-year="5">Year 5</button>
          <button class="btn hoverLift" type="button" data-year="10">Year 10</button>
          <button class="btn hoverLift" type="button" data-year="25">Year 25</button>
        </div>
      </div>

      <div class="slideBody">
        <div class="compareTop">
          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(255,59,48,.18), rgba(255,255,255,.05));">
              <div><div class="label">Utility</div><div class="title">Edison</div></div>
              <span class="tag">Red</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly bill ($)</span><input id="uPay" inputmode="decimal" value="458"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="uEsc" inputmode="decimal" value="9"></label>
              <div class="metricLine"><div class="mk">25-year utility spend</div><div class="mv" id="uTotal" style="color:var(--utility)">$0</div></div>
            </div>
          </div>

          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(52,199,89,.16), rgba(255,255,255,.05));">
              <div><div class="label">Option 1</div><div class="title">Proposal A</div></div>
              <span class="tag">Green</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly payment ($)</span><input id="aPay" inputmode="decimal" value="295"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="aEsc" inputmode="decimal" value="3.5"></label>
              <div class="metricLine"><div class="mk">Total savings over 25 years</div><div class="mv" id="aSave" style="color:var(--opt1)">$0</div></div>
            </div>
          </div>

          <div class="col">
            <div class="colHead" style="background:linear-gradient(180deg, rgba(0,194,255,.16), rgba(255,255,255,.05));">
              <div><div class="label">Option 2</div><div class="title">Proposal B</div></div>
              <span class="tag">Cyan</span>
            </div>
            <div class="colBody">
              <label><span class="klabel">Avg monthly payment ($)</span><input id="bPay" inputmode="decimal" value="325"></label>
              <label><span class="klabel">Annual increase (%)</span><input id="bEsc" inputmode="decimal" value="4.9"></label>
              <div class="metricLine"><div class="mk">Total savings over 25 years</div><div class="mv" id="bSave" style="color:var(--opt2)">$0</div></div>
            </div>
          </div>
        </div>

        <div class="yearPanel">
          <div class="yearHead">
            <div class="t"><span class="spark"></span> Annual payment comparison (synced year)</div>
            <div class="yearPill"><span class="dot2"></span> Year <span id="yearPill">1</span></div>
          </div>

          <div class="yearBody">
            <div class="wheelBox">
              <div class="wheelTop">
                <div class="yearBig" id="yearBig">1</div>
                <div class="dialBtns">
                  <button class="miniBtn" type="button" id="btnYMinus">-1</button>
                  <button class="miniBtn" type="button" id="btnYPlus">+1</button>
                  <button class="miniBtn" type="button" id="btnYReset">Reset</button>
                </div>
              </div>
              <div class="wheel"><div class="wheelList" id="wheelList"></div></div>
              <div style="color:var(--muted);font-weight:900;font-size:13px;">Scroll the year wheel. All 3 options update together.</div>
            </div>

            <div class="yearCompare">
              <div class="bigMoneyGrid">
                <div class="bigTile">
                  <div class="bk">Utility <span class="chip">Red</span></div>
                  <div class="m" style="color:var(--utility)" id="uYearPay">$0</div>
                  <div class="kwhLine"><span id="uYearKwh">$0.34</span> <span class="unit">/kWh</span></div>
                </div>
                <div class="bigTile">
                  <div class="bk">Option 1 <span class="chip">Green</span></div>
                  <div class="m" style="color:var(--opt1)" id="aYearPay">$0</div>
                  <div class="kwhLine"><span id="aYearKwh">$0.34</span> <span class="unit">/kWh</span></div>
                </div>
                <div class="bigTile">
                  <div class="bk">Option 2 <span class="chip">Cyan</span></div>
                  <div class="m" style="color:var(--opt2)" id="bYearPay">$0</div>
                  <div class="kwhLine"><span id="bYearKwh">$0.34</span> <span class="unit">/kWh</span></div>
                </div>
              </div>

              <div class="yearSavings">
                <div>Best plan ‚Äî total savings over 25 years</div>
                <div class="v" id="best25">$0</div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- SLIDE 6: Next Steps + Reviews -->
    <section class="slide luxShadow" data-slide>
      <div class="slideHead">
        <h2><span class="spark"></span> Next Steps</h2>
        <div class="pill"><span class="dot"></span> Tap a step ‚Ä¢ simple explanation</div>
      </div>

      <div class="slideBody">
        <div class="timelineWrap">
          <div class="timeline" id="timeline">
            <div class="step active" data-step="0"><div class="num">1</div><div class="t">Site survey</div><div class="d">Less than 1 week</div></div>
            <div class="step" data-step="1"><div class="num">2</div><div class="t">Engineering</div><div class="d">~ 1 week</div></div>
            <div class="step" data-step="2"><div class="num">3</div><div class="t">Permits</div><div class="d">1‚Äì12 weeks</div></div>
            <div class="step" data-step="3"><div class="num">4</div><div class="t">Install</div><div class="d">1 day ‚Äì 2 weeks</div></div>
            <div class="step" data-step="4"><div class="num">5</div><div class="t">Final inspection</div><div class="d">1‚Äì2 weeks</div></div>
            <div class="step" data-step="5"><div class="num">6</div><div class="t">PTO</div><div class="d">30‚Äì60 days</div></div>
          </div>

          <div class="rightStack">
            <div class="panel">
              <h3 id="stepTitle">Site survey</h3>
              <p id="stepBody">We verify roof measurements, electrical details, and battery placement so the final design matches your home exactly. This prevents surprises and keeps the project moving.</p>
              <div class="tip" id="stepTip">Why it matters: accuracy here reduces delays later.</div>
              <div class="tip alt">First payment: typically 1 month after PTO (Permission To Operate).</div>
            </div>

            <div class="panel">
              <h3>Companies + Google Reviews</h3>
              <p>Tap Reviews to open in a new tab.</p>

              <div class="siteGrid">
                <div class="siteRow">
                  <div class="name">SunUp Energy</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" data-open-url="https://www.sunup-energy.com">Website</button>
                    <button class="btn small hoverLift" type="button" data-open-url="https://www.google.com/search?q=sun+up+energy+reviews&client=safari">Reviews</button>
                  </div>
                </div>

                <div class="siteRow">
                  <div class="name">Fulfill Power</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" data-open-url="https://fulfillpower.com">Website</button>
                    <button class="btn small hoverLift" type="button" data-open-url="https://www.google.com/search?q=fulfill+power+reviews&client=safari">Reviews</button>
                  </div>
                </div>

                <div class="siteRow">
                  <div class="name">Energy Time Solar</div>
                  <div class="actions">
                    <button class="btn small linkish hoverLift" type="button" data-open-url="https://energytimesolar.com">Website</button>
                    <button class="btn small hoverLift" type="button" data-open-url="https://www.google.com/search?q=energy+time+solar+reviews&ie=UTF-8&oe=UTF-8&hl=en-us&client=safari&sei=Uf2DaefjFeKYkPIPyN_BiA0&dlnr=1">Reviews</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </section>

  </div>
</div>

<div class="presentBar">
  <div class="presentShell">
    <button class="btn hoverLift" id="btnPrev" type="button">Prev</button>
    <button class="btn hoverLift" id="btnStart" type="button">Start</button>
    <button class="btn primary hoverLift" id="btnNext" type="button">Next</button>
  </div>
</div>

<!-- Overlay (bills open inside same page) -->
<div class="overlay" id="overlay" aria-hidden="true">
  <div class="overlayBox">
    <div class="overlayTop">
      <div class="title" id="ovTitle">Bill</div>
      <div class="overlayActions">
        <button class="iconBtn" id="ovZoomOut" type="button">‚àí</button>
        <button class="iconBtn" id="ovZoomIn" type="button">+</button>
        <button class="iconBtn" id="ovFit" type="button">Fit</button>
        <button class="iconBtn" id="ovClose" type="button">Close</button>
      </div>
    </div>
    <div class="overlayBody">
      <div class="viewerCanvas" id="ovCanvas">
        <img id="ovImg" alt="Bill preview">
      </div>
      <div class="zoomBar">
        <div class="zoomRange"><input id="ovRange" type="range" min="0.8" max="3.0" step="0.05" value="1.2"></div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Put these files NEXT TO index.html (same folder), then open index.html:

  4A5B0E0C-50D9-4752-8469-F61A667110D8.png   (logo)
  Scebill.jpeg                               (bill without solar)
  IMG_9100.jpeg                              (bill on solar + storage)
  Outagevideo.mp4                            (outage demo)
*/
const ASSETS = {
  logo: "4A5B0E0C-50D9-4752-8469-F61A667110D8.png",
  billUtility: "Scebill.jpeg",
  billSolar: "IMG_9100.jpeg",
  outageVideo: "Outagevideo.mp4"
};

(function(){
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  if(isIOS) document.documentElement.classList.add("ios");
})();

const $ = (id)=>document.getElementById(id);

/* Header assets */
$("logoImg").src = ASSETS.logo;

/* Slides */
const slides = Array.from(document.querySelectorAll("[data-slide]"));
let idx = 0;
function show(i){
  idx = Math.max(0, Math.min(slides.length-1, i));
  slides.forEach((s,n)=>s.classList.toggle("active", n===idx));
  const pct = slides.length<=1 ? 0 : (idx/(slides.length-1))*100;
  $("progressFill").style.width = (isFinite(pct)?pct:0) + "%";
  if(idx !== 3){ try{ $("outageVideo").pause(); }catch(e){} }
}
function next(){ show(idx+1); }
function prev(){ show(idx-1); }
function start(){ show(0); }

$("btnPrev").addEventListener("click", prev);
$("btnNext").addEventListener("click", next);
$("btnStart").addEventListener("click", start);

$("btnHome").addEventListener("click", start);
$("btnPrevTop").addEventListener("click", prev);
$("btnNextTop").addEventListener("click", next);
$("btnReset").addEventListener("click", resetAll);

$("btnFS").addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
});

window.addEventListener("keydown", (e)=>{
  if(e.key==="ArrowRight"||e.key==="PageDown"||e.key===" "){ e.preventDefault(); next(); }
  if(e.key==="ArrowLeft"||e.key==="PageUp"){ e.preventDefault(); prev(); }
  if(e.key==="Home"){ e.preventDefault(); start(); }
  if(e.key==="Escape"){ if($("overlay").classList.contains("show")) closeOverlay(); }
});

/* Bills + video */
$("imgUtilityBill").src = ASSETS.billUtility;
$("imgSolarBill").src = ASSETS.billSolar;

$("outageSrc").src = ASSETS.outageVideo;
$("outageVideo").load();

/* OPEN LINKS EXTERNALLY (new tab/window) */
document.addEventListener("click",(e)=>{
  const node = e.target.closest("[data-open-url]");
  if (node){
    const url = node.getAttribute("data-open-url");
    if(url){
      e.preventDefault();
      window.open(url, "_blank", "noopener,noreferrer");
    }
    return;
  }

  const a = e.target.closest("a[href]");
  if(!a) return;
  const href = a.getAttribute("href");
  if(!href) return;
  if(href.startsWith("#") || href.startsWith("javascript:")) return;

  if(/^https?:\/\//i.test(href)){
    e.preventDefault();
    window.open(href, "_blank", "noopener,noreferrer");
  }
});

/* Money helpers */
function num(v,fallback=0){
  const x = parseFloat(String(v).replace(/[^0-9.\-]/g,""));
  return isFinite(x)?x:fallback;
}
function money(x){ const n=isFinite(x)?x:0; return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
function money2(x){ const n=isFinite(x)?x:0; return n.toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}); }

/* Slide 1: compute cost/kWh + apply to calculator */
const custMonthly = $("custMonthly");
const custUsage = $("custUsage");
const custCpkwh = $("custCpkwh");

function recalcCustomer(){
  const m = num(custMonthly.value,458);
  const kwh = Math.max(0, num(custUsage.value,12000));
  const annual = m*12;
  const cpk = (kwh>0) ? (annual/kwh) : 0;
  custCpkwh.textContent = "$" + (cpk||0).toFixed(2);
}
custMonthly.addEventListener("input", ()=>{ recalcCustomer(); });
custUsage.addEventListener("input", recalcCustomer);

$("btnApply").addEventListener("click", ()=>syncUtilityFromCustomer());
$("btnContinue").addEventListener("click", next);

/* Calculator */
const years = 25;
let currentYear = 1;

const uPay=$("uPay"), uEsc=$("uEsc"), aPay=$("aPay"), aEsc=$("aEsc"), bPay=$("bPay"), bEsc=$("bEsc");
const uTotal=$("uTotal"), aSave=$("aSave"), bSave=$("bSave");
const yearPill=$("yearPill"), yearBig=$("yearBig");
const uYearPay=$("uYearPay"), aYearPay=$("aYearPay"), bYearPay=$("bYearPay"), best25=$("best25");
const uYearKwh=$("uYearKwh"), aYearKwh=$("aYearKwh"), bYearKwh=$("bYearKwh");

function yearlyMonthly(base, escPct, year){
  const r = escPct/100;
  return base * Math.pow(1+r, Math.max(0, year-1));
}
function sum25(baseMonthly, escPct){
  let sum=0;
  for(let y=1;y<=years;y++) sum += yearlyMonthly(baseMonthly, escPct, y)*12;
  return sum;
}
function fmtKwhCost(monthly, annualKwh){
  const kwh = Math.max(0, annualKwh);
  if(!kwh) return "$0.00";
  const annual = Math.max(0, monthly)*12;
  const c = annual / kwh;
  return "$" + c.toFixed(2);
}
function recalc(){
  const U=num(uPay.value,458), UE=num(uEsc.value,9);
  const A=num(aPay.value,295), AE=num(aEsc.value,3.5);
  const B=num(bPay.value,325), BE=num(bEsc.value,4.9);

  const U25=sum25(U,UE), A25=sum25(A,AE), B25=sum25(B,BE);
  const saveA=Math.max(0,U25-A25), saveB=Math.max(0,U25-B25);

  uTotal.textContent = money(U25);
  aSave.textContent = money(saveA);
  bSave.textContent = money(saveB);

  const Uy = yearlyMonthly(U,UE,currentYear);
  const Ay = yearlyMonthly(A,AE,currentYear);
  const By = yearlyMonthly(B,BE,currentYear);

  uYearPay.textContent = money2(Uy);
  aYearPay.textContent = money2(Ay);
  bYearPay.textContent = money2(By);

  const annualKwh = num(custUsage.value,12000);
  uYearKwh.textContent = fmtKwhCost(Uy, annualKwh);
  aYearKwh.textContent = fmtKwhCost(Ay, annualKwh);
  bYearKwh.textContent = fmtKwhCost(By, annualKwh);

  best25.textContent = money(Math.max(saveA, saveB));
}
[uPay,uEsc,aPay,aEsc,bPay,bEsc].forEach(el=>{
  el.addEventListener("input", recalc);
  el.addEventListener("change", recalc);
});

function syncUtilityFromCustomer(){
  uPay.value = String(num(custMonthly.value,458));
  recalc();
}

/* Year wheel */
function setYear(y, snapWheel=false){
  currentYear = Math.max(1, Math.min(years, y));
  yearPill.textContent = String(currentYear);
  yearBig.textContent = String(currentYear);
  highlightWheel();
  recalc();
  if(snapWheel) snapWheelToYear(currentYear);
}
function nudgeYear(d){ setYear(currentYear + d, true); }

document.querySelectorAll('[data-year]').forEach(btn=>{
  btn.addEventListener("click", ()=>setYear(parseInt(btn.getAttribute("data-year"),10), true));
});
$("btnYMinus").addEventListener("click", ()=>nudgeYear(-1));
$("btnYPlus").addEventListener("click", ()=>nudgeYear(1));
$("btnYReset").addEventListener("click", ()=>setYear(1,true));

const wheelList = $("wheelList");
(function buildWheel(){
  const frag=document.createDocumentFragment();
  for(let y=1;y<=years;y++){
    const div=document.createElement("div");
    div.className="wheelItem";
    div.dataset.year=String(y);
    div.textContent="Year " + y;
    div.addEventListener("click", ()=>setYear(y,true));
    frag.appendChild(div);
  }
  wheelList.appendChild(frag);
  wheelList.addEventListener("scroll", onWheelScroll, {passive:true});
  setTimeout(()=>setYear(1,true),0);
})();
let wheelScrollTimer=null;
function onWheelScroll(){
  if(wheelScrollTimer) clearTimeout(wheelScrollTimer);
  wheelScrollTimer=setTimeout(()=>{
    const items = Array.from(wheelList.querySelectorAll(".wheelItem"));
    const rect=wheelList.getBoundingClientRect();
    const centerY=rect.top + rect.height/2;
    let best=null, bestDist=Infinity;
    for(const it of items){
      const r=it.getBoundingClientRect();
      const d=Math.abs((r.top+r.height/2)-centerY);
      if(d<bestDist){ bestDist=d; best=it; }
    }
    if(best) setYear(parseInt(best.dataset.year,10), false);
  }, 90);
}
function highlightWheel(){
  wheelList.querySelectorAll(".wheelItem").forEach(it=>{
    it.classList.toggle("active", parseInt(it.dataset.year,10)===currentYear);
  });
}
function snapWheelToYear(y){
  const target = wheelList.querySelector(`.wheelItem[data-year="${y}"]`);
  if(!target) return;
  target.scrollIntoView({block:"center", behavior: document.documentElement.classList.contains("ios") ? "auto" : "smooth"});
}

/* Next steps (highlight + explanation) */
const stepTitle=$("stepTitle"), stepBody=$("stepBody"), stepTip=$("stepTip");
const stepData = [
  {title:"Site survey", body:"We verify roof measurements, electrical details, and battery placement so the final design matches your home exactly. This prevents surprises and keeps the project moving.", tip:"Why it matters: accuracy here reduces delays later."},
  {title:"Engineering", body:"Your system is designed to code and finalized for roof, electrical, and utility requirements. This turns the concept into a build-ready plan.", tip:"Why it matters: clean engineering reduces revisions and delays."},
  {title:"Permits", body:"The city reviews and approves plans. Timing varies by city workload and project details.", tip:"Why it matters: this step has the widest range‚Äîtracking matters."},
  {title:"Install", body:"Solar and batteries are installed. Duration depends on scope and scheduling.", tip:"Why it matters: after install, you‚Äôre close to inspection and PTO."},
  {title:"Final inspection", body:"The authority verifies the install matches the approved plans and meets code.", tip:"Why it matters: passing inspection is required for PTO."},
  {title:"PTO", body:"The utility grants Permission To Operate. Often 30‚Äì60 days after inspection depending on processing.", tip:"Why it matters: PTO is the official go-live milestone."},
];
$("timeline").addEventListener("click",(e)=>{
  const step = e.target.closest(".step"); if(!step) return;
  const i = parseInt(step.dataset.step,10);
  document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
  step.classList.add("active");
  const d = stepData[i] || stepData[0];
  stepTitle.textContent=d.title; stepBody.textContent=d.body; stepTip.textContent=d.tip;
});

/* Overlay viewer for bills */
const overlay=$("overlay"), ovTitle=$("ovTitle"), ovClose=$("ovClose");
const ovZoomOut=$("ovZoomOut"), ovZoomIn=$("ovZoomIn"), ovFit=$("ovFit"), ovRange=$("ovRange");
const ovCanvas=$("ovCanvas"), ovImg=$("ovImg");

let scale=1.2, panX=0, panY=0, dragging=false, startX=0, startY=0, startPanX=0, startPanY=0, imgW=0, imgH=0;

function openOverlay(title, src){
  ovTitle.textContent = title;
  ovImg.onload = ()=>{ imgW=ovImg.naturalWidth; imgH=ovImg.naturalHeight; fitOverlay(); };
  ovImg.src = src;
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");
}
function closeOverlay(){
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
  ovImg.src="";
}
function applyOverlay(){
  scale = Math.max(0.8, Math.min(3.0, scale));
  ovRange.value = String(scale);
  ovImg.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}
function fitOverlay(){
  const box = ovCanvas.getBoundingClientRect();
  if(!imgW || !imgH || !box.width || !box.height){ scale=1.2; panX=0; panY=0; applyOverlay(); return; }
  const sx=(box.width-24)/imgW, sy=(box.height-24)/imgH;
  const fit=Math.min(sx,sy);
  scale=Math.max(0.9, Math.min(1.8, fit*1.15));
  panX=Math.max(12, (box.width - imgW*scale)/2);
  panY=Math.max(12, (box.height - imgH*scale)/2);
  applyOverlay();
}
ovCanvas.addEventListener("pointerdown",(e)=>{
  dragging=true; ovCanvas.classList.add("grabbing"); ovCanvas.setPointerCapture(e.pointerId);
  startX=e.clientX; startY=e.clientY; startPanX=panX; startPanY=panY;
});
ovCanvas.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  panX = startPanX + (e.clientX - startX);
  panY = startPanY + (e.clientY - startY);
  applyOverlay();
});
ovCanvas.addEventListener("pointerup",()=>{ dragging=false; ovCanvas.classList.remove("grabbing"); });
ovCanvas.addEventListener("pointercancel",()=>{ dragging=false; ovCanvas.classList.remove("grabbing"); });

ovRange.addEventListener("input",()=>{ scale=parseFloat(ovRange.value); applyOverlay(); });
ovZoomIn.addEventListener("click",()=>{ scale=Math.min(3.0, scale+0.15); applyOverlay(); });
ovZoomOut.addEventListener("click",()=>{ scale=Math.max(0.8, scale-0.15); applyOverlay(); });
ovFit.addEventListener("click", fitOverlay);
ovClose.addEventListener("click", closeOverlay);
overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeOverlay(); });

$("imgUtilityBill").addEventListener("click", ()=>openOverlay("Today‚Äôs bill (no solar)", ASSETS.billUtility));
$("imgSolarBill").addEventListener("click", ()=>openOverlay("Solar + storage bill example ($28)", ASSETS.billSolar));

/* Reset */
function resetAll(){
  custMonthly.value="458";
  custUsage.value="12000";
  uPay.value="458"; uEsc.value="9";
  aPay.value="295"; aEsc.value="3.5";
  bPay.value="325"; bEsc.value="4.9";
  recalcCustomer();
  syncUtilityFromCustomer();
  setYear(1,true);
  show(0);
  recalc();
}

/* Init */
recalcCustomer();
syncUtilityFromCustomer();
setYear(1,true);
recalc();
show(0);
</script>

</body>
</html>
